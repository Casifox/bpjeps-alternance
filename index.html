<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feuille de Suivi Dynamique d'Alternance</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et des utilitaires responsives -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter et couleurs de base */
        html { font-family: 'Inter', sans-serif; }
        
        /* Styles de base pour le conteneur principal */
        .page-container {
            max-width: 1200px; 
            margin: 0 auto;
            padding: 1rem; 
        }
        @media (min-width: 640px) { /* sm */
             .page-container {
                padding: 2rem;
                border: 1px solid #e0e0e0;
                border-radius: 0.75rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                margin: 2rem auto;
            }
        }

        /* Styles sp√©cifiques au tableau */
        #daily-table {
            width: 100%;
            min-width: 700px; 
            border-collapse: collapse;
            table-layout: fixed; /* Assure que les largeurs sont respect√©es */
        }
        
        /* Cellules et en-t√™tes */
        #daily-table th, #daily-table td {
            border: 1px solid #d1d5db; 
            padding: 6px 4px; 
            text-align: center;
            font-size: 0.75rem; 
            height: 40px; 
            vertical-align: top;
        }
        #daily-table th {
            background-color: #eef2ff;
            color: #1e40af;
            font-weight: 600;
        }
        
        /* Champs √©ditables */
        [contenteditable="true"] {
            display: block;
            min-height: 100%;
            width: 100%;
            padding: 2px;
            margin: 0;
            outline: none; 
            text-align: inherit;
        }
        
        /* D√©finition des largeurs (en pourcentages) */
        .col-day { width: 14%; }
        .col-hours { width: 16%; }
        .col-obs { width: 40%; } 

        /* Nouveaux styles pour les zones de signature */
        .signature-box {
            border: 2px solid #3b82f6; 
            border-radius: 0.5rem;
            height: 150px; 
            background-color: #f9fafb;
            cursor: crosshair; 
        }
        .signature-box canvas {
            display: block;
        }
        
        /* Style des Modals */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 650px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        /* ======================================================= */
        /* MEDIA QUERY POUR L'IMPRESSION (VERSION A4 PROPRE) */
        /* ======================================================= */
        @page {
            size: A4 portrait;
            margin: 0.5cm; /* Marge uniforme pour laisser de l'espace sur les bords */
        }
        
        @media print {
            /* Masquer les √©l√©ments interactifs et le modal */
            .modal { display: none !important; }
            .no-print { display: none !important; }

            /* Mise en page A4 */
            body { margin: 0; padding: 0; }
            .page-container { 
                width: 100%; 
                margin: 0; 
                padding: 0.5cm; /* Marge interne pour le contenu */
                border: none; 
                box-shadow: none; 
                max-width: none;
            }
            
            /* Optimisation des titres et informations */
            h1 { font-size: 1.2rem; margin-bottom: 0.3rem; color: #000 !important; }
            .text-indigo-700 { color: #000 !important; }
            .border-b { border-bottom-color: #000 !important; }
            .mb-6 { margin-bottom: 0.5rem; }
            
            /* Conteneur d'informations */
            .p-4.border.rounded-lg.bg-gray-50 {
                padding: 0.5rem;
                border: 1px solid #000;
                background-color: #fff;
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            .font-bold { font-weight: 700 !important; }

            /* Tableau (le plus serr√© possible) */
            .overflow-x-auto { overflow: visible !important; }
            #daily-table { 
                min-width: 100%; 
                table-layout: fixed;
                border-collapse: collapse;
            } 
            #daily-table th, #daily-table td {
                border: 1px solid #444 !important; /* Bordures plus fonc√©es */
                font-size: 0.55rem; /* Police tr√®s petite pour gagner de la place */
                padding: 2px 1px;
                height: 18px; /* Hauteur tr√®s r√©duite */
                line-height: 1;
            }
            #daily-table th { background-color: #eee !important; color: #000 !important; }
            .col-day { width: 14%; font-size: 0.6rem; }
            .col-hours { width: 16%; }
            .col-obs { width: 38%; text-align: left !important; }
            
            /* Pied de tableau (Totaux) */
            tfoot { font-size: 0.7rem; }
            tfoot .bg-indigo-100\/70 { background-color: #f0f0f0 !important; }

            /* Signatures */
            .mt-10 { margin-top: 1rem; }
            .signature-area { 
                page-break-inside: avoid; 
                width: 50% !important;
                padding: 0.5rem;
                border: none !important;
                box-shadow: none !important;
            }
            .signature-box {
                border: 1px solid #000 !important; 
                height: 60px; /* Hauteur tr√®s r√©duite √† l'impression */
                background-color: transparent !important;
            }
            .signature-area p { font-size: 0.7rem; margin-bottom: 0.2rem; color: #000 !important;}

            /* Nettoyage du contenu √©ditable */
            .placeholder-text-hidden:empty:before { content: none !important; }
            .placeholder-text-hidden.text-gray-400 { color: transparent !important; }
            
            /* G√©rer la colonne jour en mode impression */
            .col-day.sticky { position: static !important; }
        }
    </style>
</head>

<nav class="bg-blue-900 shadow-lg sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center justify-center h-16">
            <div class="flex space-x-4">
                <a href="Feuille de Suivi Dynamique dAlternance.html" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">üìÖ</span> Feuille de Suivi
                </a>
                <a href="bilan.html" class="text-gray-300 hover:bg-blue-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">üìÑ</span> Bilan p√©riodiques 
                </a>
                <a href="#" onclick="openModal('tuto-modal')" class="text-gray-300 hover:bg-blue-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">üí°</span> Tutoriel
                </a>
            </div>
        </div>
    </div>
</nav>
<body class="bg-gray-100 min-h-screen">

<!-- Modal Tutoriel -->
<div id="tuto-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">üí°</span> Guide d'utilisation
        </h3>
        
        <div class="text-left space-y-4 text-gray-800">
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                <p class="font-bold">Attention : Sauvegarde Locale Uniquement</p>
                <p>Toutes les donn√©es que vous saisissez sont sauvegard√©es **uniquement sur votre ordinateur et dans le navigateur que vous utilisez actuellement**. Si vous changez d'appareil ou nettoyez les donn√©es de votre navigateur, les informations seront perdues.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Exporter toutes vos donn√©es :</h4>
                <p>Utilisez le bouton <strong class="text-blue-600">"Exporter TOUT (JSON)"</strong> pour cr√©er un fichier de sauvegarde unique contenant les informations de la feuille de suivi (tous les mois) et du bilan. Il est conseill√© de faire des sauvegardes r√©guli√®rement.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Importer des donn√©es :</h4>
                <p>Si vous changez d'ordinateur ou si vous voulez r√©cup√©rer une sauvegarde, cliquez sur <strong class="text-yellow-600">"Importer (JSON)"</strong> et s√©lectionnez le fichier `.json` que vous aviez pr√©c√©demment export√©. Toutes vos donn√©es seront restaur√©es.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Envoyer votre sauvegarde par e-mail :</h4>
                <p>Apr√®s avoir export√© vos donn√©es, vous obtiendrez un fichier (ex: `sauvegarde-livret.json`). Vous pouvez simplement joindre ce fichier √† un e-mail comme n'importe quelle autre pi√®ce jointe pour le partager ou le conserver.</p>
            </div>
        </div>

        <button onclick="closeModal('tuto-modal')" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-full">
            J'ai compris
        </button>
    </div>
</div>
<div class="flex justify-center items-center space-x-6 py-4 bg-white shadow-md">
    <img src="cd2000.jpeg" alt="Logo CD 2000" class="h-12 object-contain">
    <img src="idsf.png" alt="Logo IDSF" class="h-12 object-contain">
</div>

<!-- Modal d'export PDF (Explicatif) -->
<div id="pdf-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">üìÑ</span> Comment exporter en PDF
        </h3>
        <p class="mb-4 text-gray-700">
            Pour obtenir un document PDF officiel, vous devez passer par la fonction d'impression de votre navigateur.
        </p>
        
        <ol class="list-decimal list-inside space-y-3 mb-6 font-semibold text-gray-800">
            <li>
                Cliquez sur le bouton **"Lancer l'impression"** ci-dessous.
            </li>
            <li>
                Dans la fen√™tre qui appara√Æt, changez la **Destination** pour **"Enregistrer au format PDF"**.
            </li>
            <li>
                V√©rifiez que le livret tient sur **une seule page A4** dans l'aper√ßu avant d'enregistrer.
            </li>
        </ol>

        <button onclick="launchPrint()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-md w-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Lancer l'impression
        </button>
    </div>
</div>


<div id="app" class="page-container bg-white">
    <header class="text-center mb-8 border-b pb-4">
        <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700">Feuille de Suivi Dynamique d'Alternance</h1>
    </header>
    
    <!-- S√©lecteurs de Mois, Ann√©e et Boutons d'action (Non imprim√©s) -->
    <div class="no-print p-4 bg-indigo-50 rounded-xl shadow-lg mb-6">
        
        <!-- Contr√¥les de Date -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
            <div class="flex items-center space-x-2">
                <label for="month-select" class="font-medium text-gray-700">Mois :</label>
                <select id="month-select" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="year-select" class="font-medium text-gray-700">Ann√©e :</label>
                <select id="year-select" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
        </div>

        <!-- Boutons de Sauvegarde/Partage/Impression -->
        <div class="flex flex-wrap items-center justify-center gap-4">
            <button onclick="exportAllData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
                ‚¨áÔ∏è Exporter TOUT (JSON)
            </button>
            <button onclick="document.getElementById('import-file').click()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
                ‚¨ÜÔ∏è Importer (JSON)
            </button>
            <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
            <button onclick="openModal('pdf-modal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
                üìÑ Exporter en PDF / Imprimer
            </button>
        </div>
        <p id="message-box" class="mt-3 text-center text-sm font-medium text-red-600"></p>
    </div>

    <!-- Informations de la fiche -->
    <div class="mb-6 p-4 border rounded-lg bg-gray-50 text-sm md:text-base shadow-sm">
        <p class="mb-2"><strong>Mois affich√© :</strong> <span id="current-month-display" class="font-bold text-indigo-800 text-lg"></span></p>
        <p class="flex flex-col sm:flex-row items-start sm:items-center">
            <strong class="mr-2">Alternant (NOM Pr√©nom) :</strong> 
            <span contenteditable="true" data-field="alternantName" class="placeholder-text-hidden font-semibold w-full sm:w-auto border-b-2 border-indigo-200 px-1 py-0.5 hover:border-indigo-500 focus:border-indigo-700 transition duration-100 rounded-sm min-w-[200px] bg-white text-gray-400">Cliquez pour saisir...</span>
        </p>
    </div>

    <!-- Conteneur du Tableau de suivi des heures (Scrollable) -->
    <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table id="daily-table" class="bg-white">
            <thead>
                <tr>
                    <th class="col-day">JOUR</th>
                    <th class="col-hours">HEURES EN STRUCTURE</th>
                    <th class="col-hours">HEURES EN FORMATION</th>
                    <th class="col-hours">HEURES D'ABSENCE (Formation)</th>
                    <th class="col-obs">OBSERVATIONS (Activit√©s / T√¢ches)</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
            <tfoot>
                 <tr class="font-bold bg-indigo-100/70 border-t-2 border-indigo-300">
                    <td style="text-align: right;" class="text-sm md:text-base text-indigo-800">TOTAL DU MOIS</td>
                    <td><div data-field="totalStructHours" class="text-indigo-800">0</div></td>
                    <td><div data-field="totalFormHours" class="text-indigo-800">0</div></td>
                    <td><div data-field="totalAbsentHours" class="text-indigo-800">0</div></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Signatures -->
    <div class="mt-10 pt-6 border-t border-gray-300">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">Zones de Signature</h2>
        <div class="flex flex-col md:flex-row justify-between gap-8 text-sm md:text-base">
            <div class="signature-area w-full md:w-[48%] bg-white p-4 rounded-xl shadow-lg">
                <p class="font-semibold mb-2 text-indigo-800">Signature de l'Alternant :</p>
                <div id="signature-alternant-box" class="signature-box">
                    <canvas id="canvas-alternant" class="w-full h-full" data-signature-id="alternant"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-alternant')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>
            <div class="signature-area w-full md:w-[48%] bg-white p-4 rounded-xl shadow-lg">
                <p class="font-semibold mb-2 text-indigo-800">Signature du Tuteur Entreprise :</p>
                <div id="signature-tuteur-box" class="signature-box">
                    <canvas id="canvas-tuteur" class="w-full h-full" data-signature-id="tuteur"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-tuteur')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const monthsFr = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    const daysFr = ["Dim.", "Lun.", "Mar.", "Mer.", "Jeu.", "Ven.", "Sam."];

    const tableBody = document.getElementById('table-body');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const currentMonthDisplay = document.getElementById('current-month-display');
    const alternantNameSpan = document.querySelector('[data-field="alternantName"]');
    const messageBox = document.getElementById('message-box');
    const placeholderText = 'Cliquez pour saisir...';
    let canvasAlternant, canvasTuteur;

    function debounce(func, delay) {
        let timeoutId;
        return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(this, args), delay); };
    }
    
    function showMessage(msg, type = 'error') {
        messageBox.textContent = msg;
        messageBox.className = 'mt-3 text-center text-sm font-medium ';
        messageBox.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
        clearTimeout(messageBox.timeoutId);
        messageBox.timeoutId = setTimeout(() => { messageBox.textContent = ''; }, 4000);
    }

    function calculateTotals() {
        const totals = { structHours: 0, formHours: 0, absentHours: 0 };
        tableBody.querySelectorAll('tr').forEach(row => {
            const getNumericValue = (field) => {
                const el = row.querySelector(`[data-col-field="${field}"]`);
                if (el) {
                    const text = el.textContent.trim().replace(',', '.');
                    const value = parseFloat(text);
                    return isNaN(value) ? 0 : value;
                }
                return 0;
            };
            totals.structHours += getNumericValue('structHours');
            totals.formHours += getNumericValue('formHours');
            totals.absentHours += getNumericValue('absentHours');
        });
        document.querySelector('[data-field="totalStructHours"]').textContent = totals.structHours.toFixed(2).replace(/\.00$/, '');
        document.querySelector('[data-field="totalFormHours"]').textContent = totals.formHours.toFixed(2).replace(/\.00$/, '');
        document.querySelector('[data-field="totalAbsentHours"]').textContent = totals.absentHours.toFixed(2).replace(/\.00$/, '');
        debouncedSaveData(); 
    }

    // --- GESTION DE LA SAUVEGARDE (LOCAL STORAGE) ---
    const getLocalStorageKey = (month, year) => `livret_alternance_data_${year}-${month}`;

    function getDataForSave() {
        const tableData = Array.from(tableBody.querySelectorAll('tr')).map(row => ({
            day: row.getAttribute('data-day-index'),
            structHours: row.querySelector('[data-col-field="structHours"]').textContent.trim(),
            formHours: row.querySelector('[data-col-field="formHours"]').textContent.trim(),
            absentHours: row.querySelector('[data-col-field="absentHours"]').textContent.trim(),
            obs: row.querySelector('[data-col-field="obs"]').textContent.trim()
        }));
        const alternantNameText = alternantNameSpan.textContent.trim();
        return {
            alternantName: (alternantNameText === placeholderText) ? "" : alternantNameText,
            signatureAlternant: canvasAlternant ? canvasAlternant.toDataURL('image/png') : null,
            signatureTuteur: canvasTuteur ? canvasTuteur.toDataURL('image/png') : null,
            tableData,
            month: monthSelect.value,
            year: yearSelect.value
        };
    }

    const debouncedSaveData = debounce(() => {
        const data = getDataForSave();
        const key = getLocalStorageKey(data.month, data.year);
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (error) { showMessage("Erreur de sauvegarde des donn√©es."); }
    }, 500); 

    function applyDataToPage(data) {
        if (!data) return;
        const nameText = data.alternantName || placeholderText;
        alternantNameSpan.textContent = nameText;
        alternantNameSpan.classList.toggle('text-gray-400', !data.alternantName);

        const tableDataMap = new Map((data.tableData || []).map(item => [item.day, item]));
        tableBody.querySelectorAll('tr').forEach(row => {
            const dayIndex = row.getAttribute('data-day-index');
            const rowData = tableDataMap.get(dayIndex);
            if (rowData) {
                row.querySelector('[data-col-field="structHours"]').textContent = rowData.structHours || '';
                row.querySelector('[data-col-field="formHours"]').textContent = rowData.formHours || '';
                row.querySelector('[data-col-field="absentHours"]').textContent = rowData.absentHours || '';
                row.querySelector('[data-col-field="obs"]').textContent = rowData.obs || '';
            }
        });
        
        loadSignature('canvas-alternant', data.signatureAlternant);
        loadSignature('canvas-tuteur', data.signatureTuteur);
        calculateTotals();
    }

    function loadCurrentMonthData() {
        const key = getLocalStorageKey(monthSelect.value, yearSelect.value);
        try {
            const storedData = localStorage.getItem(key);
            applyDataToPage(storedData ? JSON.parse(storedData) : { tableData: [] });
        } catch (error) {
            showMessage("Erreur de chargement des donn√©es sauvegard√©es.");
            applyDataToPage({ tableData: [] });
        }
    }

    // --- LOGIQUE DE DATE & TABLEAU ---
    function initSelectors() {
        const today = new Date();
        monthsFr.forEach((m, i) => monthSelect.add(new Option(m, i)));
        for (let y = today.getFullYear() - 2; y <= today.getFullYear() + 5; y++) yearSelect.add(new Option(y, y));
        monthSelect.value = today.getMonth();
        yearSelect.value = today.getFullYear();
        monthSelect.addEventListener('change', generateTable);
        yearSelect.addEventListener('change', generateTable);
    }

    function generateTable() {
        const month = parseInt(monthSelect.value), year = parseInt(yearSelect.value);
        currentMonthDisplay.textContent = `${monthsFr[month]} ${year}`;
        tableBody.innerHTML = '';
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
            const date = new Date(year, month, i);
            const dayOfWeek = date.getDay();
            const row = tableBody.insertRow();
            row.setAttribute('data-day-index', i);
            row.className = (dayOfWeek === 0 || dayOfWeek === 6) ? 'bg-gray-100 text-gray-500' : 'hover:bg-indigo-50/50';
            row.innerHTML = `
                <td class="col-day font-semibold text-left pl-2 sticky left-0 bg-white z-10">${daysFr[dayOfWeek]} ${i}</td>
                <td class="col-hours font-mono"><div contenteditable="true" data-col-field="structHours" class="h-full w-full p-1 min-h-[30px]" inputmode="decimal"></div></td>
                <td class="col-hours font-mono"><div contenteditable="true" data-col-field="formHours" class="h-full w-full p-1 min-h-[30px]" inputmode="decimal"></div></td>
                <td class="col-hours font-mono"><div contenteditable="true" data-col-field="absentHours" class="h-full w-full p-1 min-h-[30px]" inputmode="decimal"></div></td>
                <td class="col-obs text-left pl-2 text-gray-600"><div contenteditable="true" data-col-field="obs" class="h-full w-full p-1 min-h-[30px] text-xs md:text-sm"></div></td>
            `;
        }
        loadCurrentMonthData();
    }
    
    // --- LOGIQUE DE SIGNATURE (CANVAS) ---
    function initCanvasRefs() {
        canvasAlternant = document.getElementById('canvas-alternant');
        canvasTuteur = document.getElementById('canvas-tuteur');
    }
    
    function loadSignature(canvasId, base64) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !base64) return;
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = base64;
    }

    window.clearCanvas = (id) => {
        const canvas = document.getElementById(id);
        if(canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        debouncedSaveData(); 
    }

    function setupSignaturePads() {
        initCanvasRefs();
        [canvasAlternant, canvasTuteur].forEach(canvas => {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let isDrawing = false, lastX = 0, lastY = 0;

            const setCanvasSize = () => {
                const dataUrl = canvas.toDataURL();
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
                loadSignature(canvas.id, dataUrl);
            };
            setCanvasSize();

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return [clientX - rect.left, clientY - rect.top];
            };
            const start = (e) => { isDrawing = true; [lastX, lastY] = getPos(e); e.preventDefault(); };
            const draw = (e) => { if (!isDrawing) return; const [x, y] = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke(); [lastX, lastY] = [x, y]; };
            const stop = () => { if (isDrawing) { isDrawing = false; debouncedSaveData(); } };
            
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseout', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);
            window.addEventListener('resize', debounce(setCanvasSize, 250));
        });
    }

    // --- LOGIQUE DU MODAL ---
    window.openModal = (id) => { document.getElementById(id).style.display = 'flex'; }
    window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; }
    window.launchPrint = () => { closeModal('pdf-modal'); setTimeout(() => window.print(), 100); }

    // --- EXPORT / IMPORT GLOBAL ---
    function exportAllData() {
        const filename = prompt("Veuillez nommer votre fichier de sauvegarde :", `sauvegarde-livret-${new Date().toISOString().split('T')[0]}.json`);
        if (!filename) return;

        const allData = { suivi: {}, bilan: null, activites: null };
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('livret_alternance_data_')) {
                allData.suivi[key] = JSON.parse(localStorage.getItem(key));
            } else if (key === 'livret_alternance_bilan_v2_data') {
                allData.bilan = JSON.parse(localStorage.getItem(key));
            } else if (key === 'livret_alternance_activites_data') {
                allData.activites = JSON.parse(localStorage.getItem(key));
            }
        }
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename.endsWith('.json') ? filename : `${filename}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        showMessage('Exportation compl√®te r√©ussie !', 'success');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.suivi && !data.bilan) throw new Error("Format invalide");

                Object.keys(data.suivi || {}).forEach(key => localStorage.setItem(key, JSON.stringify(data.suivi[key])));
                if (data.bilan) localStorage.setItem('livret_alternance_bilan_v2_data', JSON.stringify(data.bilan));
                if (data.activites) localStorage.setItem('livret_alternance_activites_data', JSON.stringify(data.activites));
                
                showMessage('Importation r√©ussie ! La page va se recharger.', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (error) { showMessage('Erreur: Fichier invalide ou corrompu.'); }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    }
    
    // --- Lancement de l'application ---
    function initApp() {
        initCanvasRefs();
        initSelectors();
        generateTable();
        
        document.getElementById('app').addEventListener('input', (e) => {
            if (e.target.closest('[contenteditable="true"]')) {
                if (['structHours', 'formHours', 'absentHours'].includes(e.target.getAttribute('data-col-field'))) {
                    calculateTotals();
                } else {
                    debouncedSaveData();
                }
            }
        });

        alternantNameSpan.addEventListener('focus', (e) => {
            if (e.target.textContent.trim() === placeholderText) {
                e.target.textContent = '';
                e.target.classList.remove('text-gray-400');
            }
        });
        alternantNameSpan.addEventListener('blur', (e) => {
            if (e.target.textContent.trim() === '') {
                e.target.textContent = placeholderText;
                e.target.classList.add('text-gray-400');
            }
            debouncedSaveData();
        });

        setupSignaturePads();
    }

    window.onload = initApp;
</script>
<footer class="bg-blue-900 py-4 mt-10 text-center">
    <img src="bourgogne.webp" alt="Logo R√©gion" class="h-12 mx-auto">
</footer>
</body>
</html>

