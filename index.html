<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feuille de Suivi Dynamique d'Alternance</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et des utilitaires responsives -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter et couleurs de base */
        html { font-family: 'Inter', sans-serif; }
        
        /* Styles de base pour le conteneur principal */
        .page-container {
            max-width: 1200px; 
            margin: 0 auto;
            padding: 1rem; 
        }
        @media (min-width: 640px) { /* sm */
             .page-container {
                padding: 2rem;
                border: 1px solid #e0e0e0;
                border-radius: 0.75rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                margin: 2rem auto;
            }
        }

        /* Styles sp√©cifiques au tableau */
        #daily-table {
            width: 100%;
            min-width: 700px; 
            border-collapse: collapse;
            table-layout: fixed; /* Assure que les largeurs sont respect√©es */
        }
        
        /* Cellules et en-t√™tes */
        #daily-table th, #daily-table td {
            border: 1px solid #d1d5db; 
            padding: 6px 4px; 
            text-align: center;
            font-size: 0.75rem; 
            height: 40px; 
            vertical-align: top;
        }
        #daily-table th {
            background-color: #eef2ff;
            color: #1e40af;
            font-weight: 600;
        }
        
        /* Champs √©ditables */
        [contenteditable="true"] {
            display: block;
            min-height: 100%;
            width: 100%;
            padding: 2px;
            margin: 0;
            outline: none; 
            text-align: inherit;
        }
        
        /* D√©finition des largeurs (en pourcentages) */
        .col-day { width: 14%; }
        .col-hours { width: 16%; }
        .col-obs { width: 40%; } 

        /* Nouveaux styles pour les zones de signature */
        .signature-box {
            border: 2px solid #3b82f6; 
            border-radius: 0.5rem;
            height: 150px; 
            background-color: #f9fafb;
            cursor: crosshair; 
        }
        .signature-box canvas {
            display: block;
        }
        
        /* Style des Modals */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }

        /* ======================================================= */
        /* MEDIA QUERY POUR L'IMPRESSION (VERSION A4 PROPRE) */
        /* ======================================================= */
        @page {
            size: A4 portrait;
            margin: 0.5cm; /* Marge uniforme pour laisser de l'espace sur les bords */
        }
        
        @media print {
            /* Masquer les √©l√©ments interactifs et le modal */
            .modal { display: none !important; }
            .no-print { display: none !important; }

            /* Mise en page A4 */
            body { margin: 0; padding: 0; }
            .page-container { 
                width: 100%; 
                margin: 0; 
                padding: 0.5cm; /* Marge interne pour le contenu */
                border: none; 
                box-shadow: none; 
                max-width: none;
            }
            
            /* Optimisation des titres et informations */
            h1 { font-size: 1.2rem; margin-bottom: 0.3rem; color: #000 !important; }
            .text-indigo-700 { color: #000 !important; }
            .border-b { border-bottom-color: #000 !important; }
            .mb-6 { margin-bottom: 0.5rem; }
            
            /* Conteneur d'informations */
            .p-4.border.rounded-lg.bg-gray-50 {
                padding: 0.5rem;
                border: 1px solid #000;
                background-color: #fff;
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            .font-bold { font-weight: 700 !important; }

            /* Tableau (le plus serr√© possible) */
            .overflow-x-auto { overflow: visible !important; }
            #daily-table { 
                min-width: 100%; 
                table-layout: fixed;
                border-collapse: collapse;
            } 
            #daily-table th, #daily-table td {
                border: 1px solid #444 !important; /* Bordures plus fonc√©es */
                font-size: 0.55rem; /* Police tr√®s petite pour gagner de la place */
                padding: 2px 1px;
                height: 18px; /* Hauteur tr√®s r√©duite */
                line-height: 1;
            }
            #daily-table th { background-color: #eee !important; color: #000 !important; }
            .col-day { width: 14%; font-size: 0.6rem; }
            .col-hours { width: 16%; }
            .col-obs { width: 38%; text-align: left !important; }
            
            /* Pied de tableau (Totaux) */
            tfoot { font-size: 0.7rem; }
            tfoot .bg-indigo-100\/70 { background-color: #f0f0f0 !important; }

            /* Signatures */
            .mt-10 { margin-top: 1rem; }
            .signature-area { 
                page-break-inside: avoid; 
                width: 50% !important;
                padding: 0.5rem;
                border: none !important;
                box-shadow: none !important;
            }
            .signature-box {
                border: 1px solid #000 !important; 
                height: 60px; /* Hauteur tr√®s r√©duite √† l'impression */
                background-color: transparent !important;
            }
            .signature-area p { font-size: 0.7rem; margin-bottom: 0.2rem; color: #000 !important;}

            /* Nettoyage du contenu √©ditable */
            .placeholder-text-hidden:empty:before { content: none !important; }
            .placeholder-text-hidden.text-gray-400 { color: transparent !important; }
            
            /* G√©rer la colonne jour en mode impression */
            .col-day.sticky { position: static !important; }
        }
    </style>
</head>

<nav class="bg-blue-900 shadow-lg sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center justify-center h-16">
            <div class="flex space-x-4">
                <a href="index.html" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">üìÖ</span> Feuille de Suivi
                </a>
                <a href="bilan.html" class=" text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">üìÑ</span> Bilan Final
                </a>
            </div>
        </div>
    </div>
</nav>
<body class="bg-gray-100 min-h-screen">

<!-- Modal d'explication de la sauvegarde (Initial) -->
<div id="save-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">üóÇÔ∏è</span> √Ä savoir sur ce livret
        </h3>
        <p class="mb-4 text-gray-700">
            Ce livret est **dynamique** : il garde automatiquement tes donn√©es (heures, observations, signatures, etc.) d√®s que tu les entres.
        </p>
        <div class="mb-6 text-red-700 font-bold text-base border border-red-400 p-4 rounded-xl bg-red-100 shadow-lg">
            ‚ö†Ô∏è Important :
            <br>
            Tes donn√©es sont sauvegard√©es uniquement sur **cet appareil et ce navigateur**.
            <br>
            üëâ Si tu changes d‚Äôordinateur, de t√©l√©phone ou que tu supprimes ton historique, tes donn√©es seront **perdues**. Utilisez les fonctions Export/Import si besoin.
        </div>
        <button onclick="closeModal('save-modal')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-md w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            J'ai compris, commencer √† saisir
        </button>
    </div>
</div>

<!-- Modal d'export PDF (Explicatif) -->
<div id="pdf-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">üìÑ</span> Comment exporter en PDF
        </h3>
        <p class="mb-4 text-gray-700">
            Pour obtenir un document PDF officiel, vous devez passer par la fonction d'impression de votre navigateur.
        </p>
        
        <ol class="list-decimal list-inside space-y-3 mb-6 font-semibold text-gray-800">
            <li>
                Cliquez sur le bouton **"Lancer l'impression"** ci-dessous.
            </li>
            <li>
                Dans la fen√™tre qui appara√Æt, changez la **Destination** pour **"Enregistrer au format PDF"** (ou **"Microsoft Print to PDF"** selon votre syst√®me).
            </li>
            <li>
                V√©rifiez que le livret tient sur **une seule page A4** dans l'aper√ßu avant d'enregistrer.
            </li>
        </ol>

        <button onclick="launchPrint()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-md w-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Lancer l'impression
        </button>
    </div>
</div>


<div id="app" class="page-container bg-white">
    <header class="text-center mb-8 border-b pb-4">
        <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700">Feuille de Suivi Dynamique d'Alternance</h1>
    </header>
    
    <!-- S√©lecteurs de Mois, Ann√©e et Boutons d'action (Non imprim√©s) -->
    <div class="no-print p-4 bg-indigo-50 rounded-xl shadow-lg mb-6">
        
        <!-- Contr√¥les de Date -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
            <div class="flex items-center space-x-2">
                <label for="month-select" class="font-medium text-gray-700">Mois :</label>
                <select id="month-select" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="year-select" class="font-medium text-gray-700">Ann√©e :</label>
                <select id="year-select" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
        </div>

        <!-- Boutons de Sauvegarde/Partage/Impression -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-3 mt-4">
            
            <div class="flex gap-2 w-full md:w-auto">
                <!-- Export (T√©l√©charger) -->
                <button onclick="exportData()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm py-2 px-3 rounded-lg transition duration-200 shadow-md">
                    ‚¨áÔ∏è Export (JSON)
                </button>
                <!-- Import (Charger) -->
                <button onclick="document.getElementById('import-file').click()" class="flex-1 md:flex-none bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold text-sm py-2 px-3 rounded-lg transition duration-200 shadow-md">
                    ‚¨ÜÔ∏è Import (JSON)
                </button>
                <!-- Champ de fichier cach√© pour l'import -->
                <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
            </div>

             <!-- Partager -->
            <button onclick="shareData()" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold text-sm py-2 px-4 rounded-lg transition duration-200 shadow-md">
                üîó Partager les donn√©es
            </button>
            
            <!-- PDF Export / Impression (Ouvre le modal explicatif) -->
            <button onclick="openModal('pdf-modal')" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg mt-2 md:mt-0">
                üìÑ Exporter en PDF / Imprimer
            </button>
        </div>
        <p id="message-box" class="mt-3 text-center text-sm font-medium text-red-600"></p>
    </div>

    <!-- Informations de la fiche -->
    <div class="mb-6 p-4 border rounded-lg bg-gray-50 text-sm md:text-base shadow-sm">
        <p class="mb-2"><strong>Mois affich√© :</strong> <span id="current-month-display" class="font-bold text-indigo-800 text-lg"></span></p>
        <p class="flex flex-col sm:flex-row items-start sm:items-center">
            <strong class="mr-2">Alternant (NOM Pr√©nom) :</strong> 
            <span contenteditable="true" data-field="alternantName" class="placeholder-text-hidden font-semibold w-full sm:w-auto border-b-2 border-indigo-200 px-1 py-0.5 hover:border-indigo-500 focus:border-indigo-700 transition duration-100 rounded-sm min-w-[200px] bg-white text-gray-400">Cliquez pour saisir...</span>
        </p>
    </div>

    <!-- Conteneur du Tableau de suivi des heures (Scrollable) -->
    <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table id="daily-table" class="bg-white">
            <thead>
                <tr>
                    <th class="col-day">JOUR</th>
                    <th class="col-hours">HEURES EN STRUCTURE</th>
                    <th class="col-hours">HEURES EN FORMATION</th>
                    <th class="col-hours">HEURES D'ABSENCE (Formation)</th>
                    <th class="col-obs">OBSERVATIONS (Activit√©s / T√¢ches)</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Les lignes du mois seront g√©n√©r√©es ici par JavaScript -->
            </tbody>
            <tfoot>
                 <tr class="font-bold bg-indigo-100/70 border-t-2 border-indigo-300">
                    <td style="text-align: right;" class="text-sm md:text-base text-indigo-800">TOTAL DU MOIS</td>
                    <!-- Les champs d'heures sont maintenant en lecture seule pour les totaux automatiques -->
                    <td data-field-column="structHours">
                        <div data-field="totalStructHours" class="text-indigo-800">0</div>
                    </td>
                    <td data-field-column="formHours">
                        <div data-field="totalFormHours" class="text-indigo-800">0</div>
                    </td>
                    <td data-field-column="absentHours">
                        <div data-field="totalAbsentHours" class="text-indigo-800">0</div>
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Signatures (responsive: stack on mobile, side-by-side on tablet+) -->
    <div class="mt-10 pt-6 border-t border-gray-300">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">Zones de Signature</h2>
        <div class="flex flex-col md:flex-row justify-between gap-8 text-sm md:text-base">
            
            <!-- Signature Alternant -->
            <div class="signature-area w-full md:w-[48%] bg-white p-4 rounded-xl shadow-lg">
                <p class="font-semibold mb-2 text-indigo-800">Signature de l'Alternant :</p>
                <div id="signature-alternant-box" class="signature-box">
                    <canvas id="canvas-alternant" class="w-full h-full" data-signature-id="alternant"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-alternant')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>
            
            <!-- Signature Tuteur -->
            <div class="signature-area w-full md:w-[48%] bg-white p-4 rounded-xl shadow-lg">
                <p class="font-semibold mb-2 text-indigo-800">Signature du Tuteur Entreprise :</p>
                <div id="signature-tuteur-box" class="signature-box">
                    <canvas id="canvas-tuteur" class="w-full h-full" data-signature-id="tuteur"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-tuteur')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>

        </div>
    </div>
</div>

<script type="text/javascript">

    // =======================================================
    // VARIABLES GLOBALES & INITIALISATION
    // =======================================================

    const monthsFr = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    const daysFr = ["Dim.", "Lun.", "Mar.", "Mer.", "Jeu.", "Ven.", "Sam."];

    const tableBody = document.getElementById('table-body');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const currentMonthDisplay = document.getElementById('current-month-display');
    const alternantNameSpan = document.querySelector('[data-field="alternantName"]');
    const messageBox = document.getElementById('message-box');
    const placeholderText = 'Cliquez pour saisir...';

    // R√©f√©rences aux canvas de signature pour la port√©e globale (r√©sout l'erreur)
    let canvasAlternant;
    let canvasTuteur;

    // =======================================================
    // UTILS : MESSAGES ET DEBOUNCE
    // =======================================================

    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    function showMessage(msg, type = 'error') {
        messageBox.textContent = msg;
        messageBox.classList.remove('text-red-600', 'text-green-600');
        messageBox.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
        
        clearTimeout(messageBox.timeoutId);
        messageBox.timeoutId = setTimeout(() => {
            messageBox.textContent = '';
        }, 3000);
    }

    // =======================================================
    // GESTION DU CALCUL AUTOMATIQUE DES TOTAUX (NOUVEAU)
    // =======================================================

    /**
     * Calcule et affiche les totaux pour toutes les colonnes d'heures.
     */
    function calculateTotals() {
        const totalStruct = { element: document.querySelector('[data-field="totalStructHours"]'), sum: 0 };
        const totalForm = { element: document.querySelector('[data-field="totalFormHours"]'), sum: 0 };
        const totalAbsent = { element: document.querySelector('[data-field="totalAbsentHours"]'), sum: 0 };

        // Parcourt toutes les lignes du tableau
        tableBody.querySelectorAll('tr').forEach(row => {
            const getNumericValue = (day, field) => {
                const el = row.querySelector(`[data-row-day="${day}"][data-col-field="${field}"]`);
                if (el) {
                    // Supprime les espaces et remplace la virgule par un point (pour les nombres d√©cimaux)
                    const text = el.textContent.trim().replace(',', '.');
                    const value = parseFloat(text);
                    return isNaN(value) ? 0 : value;
                }
                return 0;
            };

            const dayIndex = row.getAttribute('data-day-index');
            
            totalStruct.sum += getNumericValue(dayIndex, 'structHours');
            totalForm.sum += getNumericValue(dayIndex, 'formHours');
            totalAbsent.sum += getNumericValue(dayIndex, 'absentHours');
        });

        // Afficher les totaux avec deux d√©cimales (toFixed(2)) ou sans si c'est un entier
        totalStruct.element.textContent = totalStruct.sum.toFixed(2).replace(/\.00$/, '');
        totalForm.element.textContent = totalForm.sum.toFixed(2).replace(/\.00$/, '');
        totalAbsent.element.textContent = totalAbsent.sum.toFixed(2).replace(/\.00$/, '');

        // Important: sauvegarder apr√®s le calcul
        debouncedSaveData(); 
    }

    // =======================================================
    // GESTION DE LA SAUVEGARDE (LOCAL STORAGE)
    // =======================================================

    function getLocalStorageKey(month, year) {
        return `livret_alternance_data_${year}-${month}`;
    }

    // 1. R√©cup√©rer les donn√©es de la page
    function getDataForSave() {
        const tableData = [];
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach((row) => {
            const dayIndex = row.getAttribute('data-day-index');
            // Cibler les div contenteditable par leur attribut data-col-field
            const cells = [
                row.querySelector('[data-col-field="structHours"]'),
                row.querySelector('[data-col-field="formHours"]'),
                row.querySelector('[data-col-field="absentHours"]'),
                row.querySelector('[data-col-field="obs"]')
            ].filter(el => el); // Filtrer les √©l√©ments qui pourraient √™tre null
            
            if (cells.length === 4) {
                // Fonction utilitaire pour nettoyer le texte
                const getCleanText = (el) => el.textContent.trim().replace(/\s+/g, ' '); 

                tableData.push({
                    day: dayIndex, 
                    structHours: getCleanText(cells[0]),
                    formHours: getCleanText(cells[1]),
                    absentHours: getCleanText(cells[2]),
                    obs: getCleanText(cells[3])
                });
            }
        });

        // Retirer le placeholder si pr√©sent
        const alternantNameText = alternantNameSpan.textContent.trim();
        const alternantName = (alternantNameText === placeholderText) ? "" : alternantNameText;

        // Les totaux sont lus de la page (calcul√©s par calculateTotals)
        const totalStructHours = document.querySelector('[data-field="totalStructHours"]').textContent.trim();
        const totalFormHours = document.querySelector('[data-field="totalFormHours"]').textContent.trim();
        const totalAbsentHours = document.querySelector('[data-field="totalAbsentHours"]').textContent.trim();
        
        // CORRECTION DE L'ERREUR DE R√âF√âRENCE : Utiliser les variables globales 'canvasAlternant' et 'canvasTuteur'
        const signatureAlternant = canvasAlternant ? canvasAlternant.toDataURL('image/png') : null;
        const signatureTuteur = canvasTuteur ? canvasTuteur.toDataURL('image/png') : null;

        return {
            alternantName,
            totalStructHours,
            totalFormHours,
            totalAbsentHours,
            signatureAlternant,
            signatureTuteur,
            tableData,
            month: monthSelect.value,
            year: yearSelect.value,
            lastUpdated: new Date().toISOString(),
        };
    }

    // 2. Sauvegarder les donn√©es dans localStorage (Debounced)
    const debouncedSaveData = debounce(() => {
        const data = getDataForSave();
        const key = getLocalStorageKey(data.month, data.year);

        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (error) {
            console.error("Erreur de sauvegarde localStorage:", error);
            showMessage("Erreur: Impossible de sauvegarder les donn√©es (Espace de stockage plein ?)");
        }
    }, 500); 

    // 3. Appliquer les donn√©es charg√©es sur la page
    function applyDataToPage(data) {
        if (!data) return;
        
        // Informations g√©n√©rales
        const nameText = data.alternantName || placeholderText;
        alternantNameSpan.textContent = nameText;
        
        if (data.alternantName) {
            alternantNameSpan.classList.remove('text-gray-400');
        } else {
            alternantNameSpan.classList.add('text-gray-400');
        }

        // On n'applique plus les totaux directement car ils sont recalcul√©s
        // document.querySelector('[data-field="totalStructHours"]').textContent = data.totalStructHours || '0';
        // document.querySelector('[data-field="totalFormHours"]').textContent = data.totalFormHours || '0';
        // document.querySelector('[data-field="totalAbsentHours"]').textContent = data.totalAbsentHours || '0';

        // Donn√©es du tableau
        const tableDataMap = new Map((data.tableData || []).map(item => [item.day, item]));
        
        tableBody.querySelectorAll('tr').forEach((row) => {
            const dayIndex = row.getAttribute('data-day-index');
            const rowData = tableDataMap.get(dayIndex);
            
            // Cibler les divs contenteditable par leur attribut
            const structCell = row.querySelector('[data-col-field="structHours"]');
            const formCell = row.querySelector('[data-col-field="formHours"]');
            const absentCell = row.querySelector('[data-col-field="absentHours"]');
            const obsCell = row.querySelector('[data-col-field="obs"]');
            
            if (rowData) {
                if (structCell) structCell.textContent = rowData.structHours || '';
                if (formCell) formCell.textContent = rowData.formHours || '';
                if (absentCell) absentCell.textContent = rowData.absentHours || '';
                if (obsCell) obsCell.textContent = rowData.obs || '';
            }
        });
        
        // Recalculer les totaux apr√®s le chargement des donn√©es
        calculateTotals();

        // Signatures
        loadSignature('canvas-alternant', data.signatureAlternant);
        loadSignature('canvas-tuteur', data.signatureTuteur);
    }

    // 4. Mettre en place la lecture de localStorage
    function setupDataListener() {
        const key = getLocalStorageKey(monthSelect.value, yearSelect.value);

        try {
            const storedData = localStorage.getItem(key);
            if (storedData) {
                const data = JSON.parse(storedData);
                applyDataToPage(data);
            } else {
                applyDataToPage({ 
                    alternantName: '', 
                    totalStructHours: '0', 
                    totalFormHours: '0', 
                    totalAbsentHours: '0', 
                    tableData: [],
                    signatureAlternant: null,
                    signatureTuteur: null
                });
                debouncedSaveData();
            }
        } catch (error) {
            console.error("Erreur de chargement ou de parsing localStorage:", error);
            showMessage("Erreur lors du chargement des donn√©es sauvegard√©es.");
        }
    }


    // =======================================================
    // FONCTIONNALIT√âS EXPORT / IMPORT / PARTAGE / PDF
    // =======================================================

    // Export: T√©l√©charge les donn√©es du mois actif dans un fichier JSON
    window.exportData = function() {
        const data = getDataForSave();
        const json = JSON.stringify(data, null, 2);
        const monthName = monthsFr[parseInt(data.month)];
        const filename = `livret_alternance_${monthName}_${data.year}.json`;
        
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage(`Fichier '${filename}' export√© (JSON) avec succ√®s.`, 'success');
    }
    
    // Import: Charge les donn√©es √† partir d'un fichier JSON
    window.importData = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type !== 'application/json') {
            showMessage("Veuillez s√©lectionner un fichier JSON valide.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!importedData.month || !importedData.year || !importedData.tableData) {
                    throw new Error("Format de donn√©es invalide.");
                }

                const key = getLocalStorageKey(importedData.month, importedData.year);
                localStorage.setItem(key, JSON.stringify(importedData));
                
                monthSelect.value = importedData.month;
                yearSelect.value = importedData.year;
                generateTable(); 
                
                showMessage(`Donn√©es du mois de ${monthsFr[parseInt(importedData.month)]} ${importedData.year} import√©es et charg√©es.`, 'success');
            } catch (error) {
                console.error("Erreur d'importation:", error);
                showMessage("Erreur: Le fichier est corrompu ou au mauvais format.");
            }
        };
        reader.readAsText(file);
    }
    
    // Partage: Copie les donn√©es brutes dans le presse-papiers
    window.shareData = function() {
        const data = getDataForSave();
        const json = JSON.stringify(data);
        
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = json;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showMessage("Donn√©es du mois copi√©es dans le presse-papiers. Collez-les pour les partager.", 'success');
            } else {
                 showMessage("Impossible de copier les donn√©es. Veuillez le faire manuellement.");
            }
        } catch (err) {
            console.error('Erreur de copie:', err);
            showMessage("Impossible de copier. Erreur syst√®me.");
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }

    // PDF Export: Ouvre le modal explicatif
    window.exportToPdf = function() {
        openModal('pdf-modal');
    }
    
    // Lancer l'impression apr√®s l'explication
    window.launchPrint = function() {
        closeModal('pdf-modal');
        window.print(); 
    }


    // =======================================================
    // LOGIQUE DE DATE & TABLEAU 
    // =======================================================

    function initSelectors() {
        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        monthsFr.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            monthSelect.appendChild(option);
        });
        
        const maxYear = new Date().getFullYear() + 5; 
        for (let y = currentYear - 2; y <= maxYear; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y;
            yearSelect.appendChild(option);
        }

        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;

        monthSelect.addEventListener('change', generateTable);
        yearSelect.addEventListener('change', generateTable);
        
        // Attacher l'√©v√©nement d'input √† la racine pour la d√©l√©gation
        document.addEventListener('input', (e) => {
            if (e.target.closest('[contenteditable="true"]')) {
                // Si l'input est dans une colonne d'heures, recalculer les totaux
                if (e.target.getAttribute('data-col-field') === 'structHours' ||
                    e.target.getAttribute('data-col-field') === 'formHours' ||
                    e.target.getAttribute('data-col-field') === 'absentHours') {
                    
                    // Valider l'entr√©e pour s'assurer que c'est un nombre valide
                    let value = e.target.textContent.trim().replace(',', '.');
                    if (value !== '' && isNaN(parseFloat(value))) {
                        // Option : Effacer ou afficher un message d'erreur si l'entr√©e n'est pas un nombre
                        // Pour l'instant, on laisse la valeur non valide pour la saisie, mais on la traite comme 0 pour le calcul
                        e.target.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
                    } else {
                         e.target.style.backgroundColor = 'transparent';
                    }

                    calculateTotals();
                }
                
                // Sauvegarder (pour toutes les cellules √©ditables)
                debouncedSaveData();
            }
        });

        // Gestion du placeholder pour l'alternant name
        alternantNameSpan.addEventListener('focus', (e) => {
            if (e.target.textContent.trim() === placeholderText) {
                e.target.textContent = '';
                e.target.classList.remove('text-gray-400');
            }
        });
        alternantNameSpan.addEventListener('blur', (e) => {
            if (e.target.textContent.trim() === '') {
                e.target.textContent = placeholderText;
                e.target.classList.add('text-gray-400');
            }
            debouncedSaveData();
        });
    }

    function generateTable() {
        const selectedMonth = parseInt(monthSelect.value);
        const selectedYear = parseInt(yearSelect.value);

        currentMonthDisplay.textContent = `${monthsFr[selectedMonth]} ${selectedYear}`;
        tableBody.innerHTML = '';

        const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            const date = new Date(selectedYear, selectedMonth, i);
            const dayOfWeekIndex = date.getDay(); 
            const dayOfWeekFr = daysFr[dayOfWeekIndex];

            const row = document.createElement('tr');
            row.setAttribute('data-day-index', i); 
            
            if (dayOfWeekIndex === 0 || dayOfWeekIndex === 6) { 
                row.classList.add('bg-gray-100', 'text-gray-500');
            } else {
                row.classList.add('hover:bg-indigo-50/50');
            }

            const cellDay = document.createElement('td');
            cellDay.classList.add('col-day', 'font-semibold', 'text-left', 'pl-2', 'sticky', 'left-0', 'bg-white', 'z-10'); 
            cellDay.textContent = `${dayOfWeekFr} ${i}`;
            row.appendChild(cellDay);
            
            const fields = ["structHours", "formHours", "absentHours", "obs"];
            for (let j = 0; j < 4; j++) {
                const cell = document.createElement('td');
                
                const contentDiv = document.createElement('div');
                contentDiv.contentEditable = "true";
                contentDiv.setAttribute('data-row-day', i);
                contentDiv.setAttribute('data-col-field', fields[j]);
                contentDiv.classList.add('h-full', 'w-full', 'p-1', 'min-h-[30px]', 'placeholder-text-hidden');

                // Rendre les champs d'heures plus visibles pour la saisie
                if (j < 3) {
                    contentDiv.classList.add('text-center', 'border', 'border-gray-300', 'rounded', 'bg-white');
                    // Autoriser uniquement la saisie num√©rique (via le clavier, pas l'attribut type)
                    contentDiv.setAttribute('inputmode', 'decimal'); 
                    contentDiv.setAttribute('placeholder', '0');
                }
                
                if (j === 3) { 
                    cell.classList.add('col-obs', 'text-left', 'pl-2', 'text-gray-600');
                    contentDiv.classList.add('text-xs', 'md:text-sm');
                } else { 
                    cell.classList.add('col-hours', 'font-mono');
                    contentDiv.classList.add('text-base', 'font-semibold');
                }
                
                cell.appendChild(contentDiv);
                row.appendChild(cell);
            }
            tableBody.appendChild(row);
        }

        setupSignaturePads();
        setupDataListener(); 
        // Les totaux sont calcul√©s √† la fin de setupDataListener apr√®s le chargement des donn√©es.
    }


    // =======================================================
    // LOGIQUE DE SIGNATURE (CANVAS)
    // =======================================================
    // Initialisation des canvas pour une port√©e globale
    
    function initCanvasRefs() {
        canvasAlternant = document.getElementById('canvas-alternant');
        canvasTuteur = document.getElementById('canvas-tuteur');
    }
    
    function loadSignature(canvasId, base64Image) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const box = canvas.parentElement;
        
        // Redimensionner le canvas pour qu'il corresponde √† la taille du conteneur
        canvas.width = box.clientWidth;
        canvas.height = box.clientHeight;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        
        // Si aucune image n'est fournie, ou si elle est vide, on arr√™te
        if (!base64Image || base64Image.includes('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYGD4DwAChwGB+AAA5nQkTAAAAABJRU5ErkJggg==')) return;

        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = base64Image;
    }

    window.clearCanvas = function(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            debouncedSaveData(); 
        }
    }

    function setupSignaturePads() {
        initCanvasRefs(); // S'assurer que les r√©f√©rences globales sont √† jour

        [canvasAlternant, canvasTuteur].forEach(canvas => {
            if (!canvas) return;

            const box = canvas.parentElement;
            const ctx = canvas.getContext('2d');

            function setCanvasDimensionsAndStyle() {
                canvas.width = box.clientWidth;
                canvas.height = box.clientHeight;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000000';
            }
            
            function redrawSignature() {
                // S'assurer que les donn√©es de la signature sont recharg√©es apr√®s un redimensionnement
                const data = getDataForSave();
                const signatureKey = canvas.id === 'canvas-alternant' ? data.signatureAlternant : data.signatureTuteur;
                loadSignature(canvas.id, signatureKey);
            }
            
            setCanvasDimensionsAndStyle(); 

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function draw(e) {
                if (!isDrawing) return;
                
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const rect = canvas.getBoundingClientRect();
                const currentX = clientX - rect.left;
                const currentY = clientY - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();

                [lastX, lastY] = [currentX, currentY];
            }

            const startDrawing = (e) => {
                isDrawing = true;
                let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = canvas.getBoundingClientRect();
                [lastX, lastY] = [clientX - rect.left, clientY - rect.top];
                e.preventDefault(); 
            };
            const stopDrawing = () => {
                if (isDrawing) {
                    isDrawing = false;
                    debouncedSaveData(); 
                }
            };
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            // Redimensionnement
            window.addEventListener('resize', debounce(() => {
                setCanvasDimensionsAndStyle();
                redrawSignature();
            }, 300));
        });
    }

    // =======================================================
    // LOGIQUE DU MODAL
    // =======================================================

    window.openModal = function(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    window.closeModal = function(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'none';
        }
        // Marquer le modal d'accueil comme vu une fois qu'il est ferm√©.
        if (id === 'save-modal') {
             localStorage.setItem('livret_modal_shown', 'true');
        }
    }
    
    function showWelcomeModal() {
        if (!localStorage.getItem('livret_modal_shown')) {
            openModal('save-modal');
        }
    }

    // Lancement de l'application
    function initApp() {
        initCanvasRefs(); // Initialiser les r√©f√©rences au chargement
        initSelectors();
        generateTable(); 
        showWelcomeModal();
    }

    window.onload = initApp;
</script>
</body>
</html>
