<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilan d'Évaluation Tuteur - Alternance BPJEPS</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter et styles de conteneur */
        html { font-family: 'Inter', sans-serif; }
        
        .page-container {
            max-width: 1100px; /* Légèrement plus large pour la lisibilité des colonnes */
            margin: 0 auto;
            padding: 1rem; 
        }
        
        /* STYLE PROFESSIONNEL: Conteneur principal (La "Fiche") */
        .professional-card {
            background-color: white;
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Ombre très légère */
            border: 1px solid #e5e7eb; /* Bordure légère */
            padding: 2.5rem;
            transition: all 0.3s;
        }

        @media (min-width: 640px) { /* sm */
             .page-container {
                padding: 2rem;
            }
        }
        
        /* Styles pour les champs éditables (clairs et encadrés) */
        [contenteditable="true"] {
            /* Couleur de fond très légère pour indiquer l'éditabilité */
            background-color: #f9fafb; 
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 4px;
            padding: 4px 6px;
            min-width: 50px;
            display: inline-block;
            transition: all 0.2s;
            outline: none;
            cursor: text;
        }
        [contenteditable="true"]:focus {
            border-color: #1e40af; /* Blue-800 pour le focus */
            background-color: #fff;
            box-shadow: 0 0 0 1px #1e40af;
        }

        /* Afficher un placeholder visible en ligne, mais invisible à l'impression */
        [contenteditable="true"]:empty:not(:focus)::before {
            content: attr(data-placeholder);
            color: #9ca3af; /* Gray-400 */
            font-style: italic;
            opacity: 0.9;
        }
        
        /* Style pour les champs de motivation qui s'auto-adaptent */
        .auto-grow-motivation {
            min-height: 44px; /* Hauteur minimale légèrement augmentée */
            overflow-y: hidden; 
            box-sizing: border-box;
            line-height: 1.4; 
            
            /* FIX CRITIQUE: Empêche le débordement du texte hors de la cellule */
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            word-break: break-all;
        }

        /* ---------------------------------------------------------------------- */
        /* --- NOUVEAU SYSTÈME DE NOTATION PAR CROIX (sans menu déroulant) ---   */
        /* ---------------------------------------------------------------------- */

        /* Conteneur des cases de notation. Aligne horizontalement les 3 cases A, E, N */
        .notation-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem; /* espace plus généreux entre les cases */
        }

        /* Case individuelle de notation
           Les cases sont maintenant suffisamment larges pour afficher le libellé (Acquis, En cours, Non acquis).
           Elles sont colorées par défaut et contiennent un indicateur de sélection (croix) positionné dans le coin supérieur droit. */
        .notation-box {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.4rem 0.75rem;
            min-width: 6rem;
            height: auto;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            color: #1f2937;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }

        /* Effet de survol pour donner du relief */
        .notation-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /*
         * Coloration par défaut des cases de notation
         * afin que la première case apparaisse en vert, la seconde en orange
         * et la troisième en rouge avant même qu'une sélection ne soit effectuée.
         * Les classes "selected-" existantes renforcent ces couleurs et affichent
         * le symbole "✕" lorsque l'utilisateur clique sur une case.
         */
        .notation-box[data-value="A"] {
            background-color: #dcfce7; /* vert très clair */
            border-color: #16a34a;     /* vert */
            color: #065f46;            /* vert foncé */
        }
        .notation-box[data-value="E"] {
            background-color: #fef9c3; /* jaune très clair / orange pâle */
            border-color: #f59e0b;     /* orange */
            color: #b45309;            /* orange foncé */
        }
        .notation-box[data-value="N"] {
            background-color: #fee2e2; /* rouge très clair */
            border-color: #ef4444;     /* rouge */
            color: #991b1b;            /* rouge foncé */
        }

        /* Afficher une croix (✕) seulement quand sélectionné.
           La croix est positionnée en haut à droite pour ne pas masquer le texte. */
        .notation-box::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.9rem;
        }
        .notation-box.selected-A::after,
        .notation-box.selected-E::after,
        .notation-box.selected-N::after {
            content: '✕';
        }

        /* État sélectionné pour "Acquis" */
        .notation-box.selected-A {
            background-color: #dcfce7; /* vert très clair */
            border-color: #16a34a;     /* vert */
            color: #065f46;            /* vert foncé */
        }

        /* État sélectionné pour "En cours d'acquisition" */
        .notation-box.selected-E {
            background-color: #fef9c3; /* jaune très clair / orange pâle */
            border-color: #f59e0b;     /* orange */
            color: #b45309;            /* orange foncé */
        }

        /* État sélectionné pour "Non acquis" */
        .notation-box.selected-N {
            background-color: #fee2e2; /* rouge très clair */
            border-color: #ef4444;     /* rouge */
            color: #991b1b;            /* rouge foncé */
        }


        /* Styles de la table d'évaluation */
        .evaluation-table {
            width: 100%;
            border-collapse: separate; /* Permet d'appliquer border-radius au conteneur */
            border-spacing: 0;
        }
        
        .evaluation-table th, .evaluation-table td {
            border: 0; /* Suppression des bordures individuelles */
            padding: 1rem 0.75rem;
            text-align: left;
            vertical-align: middle;
        }
        
        /* Bordures horizontales légères */
        .evaluation-table tbody tr {
            border-bottom: 1px solid #f3f4f6; 
        }
        .evaluation-table tbody tr:last-child {
            border-bottom: none;
        }

        /* En-tête de table (Dark Gray) */
        .evaluation-table thead th {
            background-color: #1f2937; /* Gris très foncé / Noir léger */
            color: white;
            font-weight: 600;
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }
        .evaluation-table thead tr th:first-child { border-top-left-radius: 8px; }
        .evaluation-table thead tr th:last-child { border-top-right-radius: 8px; }

        /* Styles pour les sous-titres de table (Bilan 3 - Light Blue Accent) */
        .evaluation-table .subsection-title {
            background-color: #eff6ff; /* Bleu très pâle (Blue-50) */
            font-weight: 700;
            color: #1e40af; /* Bleu marine (Blue-800) - Nouvelle couleur forte */
            padding: 0.75rem;
            border-bottom: 2px solid #bfdbfe; /* Blue-200 */
            font-style: italic;
        }

        /* En-tête de section principal (Deep Blue) */
        .bilan-header {
            background-color: #1e3a8a; /* Bleu très foncé (Blue-900) - Nouvelle couleur principale */
            color: white;
            text-align: center;
            font-weight: 700;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            letter-spacing: 0.08em;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.2);
            font-size: 1.25rem;
        }
        
        /* Style pour la zone d'avertissement */
        .alert-box {
            background-color: #f0f9ff; /* Blue-50 */
            border-left: 4px solid #0056b3; /* Un bleu plus profond */
            color: #0056b3;
            padding: 1rem;
            border-radius: 4px;
        }


        /* ---------------------------------------------------------------------- */
        /* --- OPTIMISATION POUR L'IMPRESSION (PDF) ---                         */
        /* ---------------------------------------------------------------------- */

        @media print {
            /* Masquer tous les éléments interactifs et d'interface */
            .no-print {
                display: none !important;
            }
            
            /* Réinitialiser le conteneur principal à une page simple */
            .page-container, .professional-card {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
            body {
                background-color: white !important;
                /* Aides à l'impression (s'assurer que les éléments ne sont pas coupés) */
                orphans: 3;
                widows: 3;
            }

            /* Forcer l'impression des couleurs et fonds pour la structure (Clé de l'impression couleur) */
            .evaluation-table th, .evaluation-table .subsection-title, .bilan-header, .alert-box, .p-4.bg-gray-50 {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            /* Conserver les styles de couleurs des en-têtes */
            .evaluation-table th { background-color: #1f2937 !important; color: white !important; }
            .evaluation-table .subsection-title { 
                background-color: #eff6ff !important; 
                color: #1e40af !important; /* Bleu marine */
                border-bottom: 1px solid #e5e7eb !important; 
            }
            .bilan-header { background-color: #1e3a8a !important; color: white !important; border-radius: 0 !important; }
            .alert-box { background-color: #f0f9ff !important; border-left-color: #0056b3 !important; color: #0056b3 !important;}


            /* Rendre les champs de saisie invisibles, ne garder que le texte */
            [contenteditable="true"] {
                 background-color: white !important;
                 border: none !important;
                 padding: 0 !important;
                 /* Forcer le contenu à être affiché comme du texte simple */
                 display: block !important;
                 min-height: 1.5em !important;
            }
            
            /* Rendre le placeholder invisible à l'impression */
            [contenteditable="true"]:empty:not(:focus)::before {
                content: none !important;
            }
            
            /* Sélecteurs de notation : masquer la balise <select> et afficher le texte uniquement */
            .evaluation-table select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background: none;
                border: none;
                font-weight: bold;
                padding: 0;
                color: #1f2937; /* Couleur du texte des notations */
            }

            /* Styles pour la zone de motivation (texte long) */
             .auto-grow-motivation {
                overflow: visible !important; /* Autoriser le texte à s'étendre */
                height: auto !important;
                min-height: 1.5em !important; /* Hauteur minimale pour les champs vides ou courts */
                padding: 0 !important;
                border: none !important;
                background-color: white !important;
             }
             
             /* Styles des sections d'informations (Nom, Tuteur, Structure) */
             .p-4.bg-gray-50 {
                 border: 1px solid #e5e7eb !important; /* Conserver une bordure légère */
                 background-color: white !important;
                 padding: 8px !important;
                 margin-bottom: 8px !important;
             }
             
             /* Signatures : s'assurer que le cadre est visible et le bouton effacer invisible */
             #signature-stagiaire, #signature-tuteur {
                 border: 1px solid #d1d5db !important;
             }
        }
    </style>
</head>
<nav class="bg-blue-900 shadow-lg sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center justify-center h-16">
            <div class="flex space-x-4">
                <a href="index.html" class="text-gray-300 hover:bg-blue-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">📅</span> Feuille de Suivi
                </a>
                <a href="bilan.html" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">📄</span> Bilan périodiques 
                </a>
            </div>
        </div>
    </div>
</nav>

<body class="bg-gray-50">
    <div id="app" class="page-container">
        <!-- Message Box -->
        <div id="message-box" class="fixed top-4 right-4 z-50 no-print"></div>
        
        <!-- Modal pour la saisie du nom de fichier -->
        <div id="filename-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-[100] hidden no-print">
            <div class="bg-white rounded-xl shadow-2xl p-7 w-11/12 max-w-md transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Exporter les Bilans</h3>
                <p class="text-gray-600 mb-5 text-sm">Saisissez le nom pour l'exportation JSON qui contient les données de tous les bilans.</p>
                
                <label for="filename-input" class="block text-sm font-medium text-gray-700 mb-2">Nom du fichier (.json) :</label>
                <input type="text" id="filename-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-600 focus:border-blue-600 mb-6 text-lg" placeholder="Ex: Bilans_Alternance_Jean_DUPONT">
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeFilenameModal()" class="px-5 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
                        Annuler
                    </button>
                    <button onclick="performExport()" class="px-5 py-2 text-white bg-blue-700 rounded-lg shadow-md hover:bg-blue-800 transition duration-150 font-medium">
                        Télécharger
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Fin de Modal -->

        <!-- Contenu principal encapsulé dans la carte professionnelle -->
        <div class="professional-card">

            <header class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2 tracking-tight">LIVRET D'ALTERNANCE</h1>
                <h2 class="text-xl font-medium text-gray-600">FICHE D'ÉVALUATION DU TUTEUR (BPJEPS APT)</h2>
            </header>

            <!-- Section Boutons d'Action (Masquée à l'impression grâce à no-print) -->
            <div class="no-print mb-8 p-5 bg-gray-100 rounded-xl shadow-md border border-gray-200 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-6">
                
                <!-- Sélecteur de Bilan (Onglets) -->
                <div class="flex items-center space-x-3 w-full md:w-auto">
                    <label for="bilan-select" class="text-base font-semibold text-gray-700 whitespace-nowrap">Bilan en cours :</label>
                    <select id="bilan-select" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-700 focus:border-blue-700 transition duration-150 ease-in-out bg-white text-gray-800 w-full md:w-auto">
                        <!-- Les valeurs correspondent aux clés dans EVALUATION_CRITERIA -->
                        <option value="1">Bilan 1</option>
                        <option value="2">Bilan 2</option>
                        <option value="3">Bilan 3</option>
                    </select>
                </div>
                
                
                <p id="bilan-period" class="text-lg font-bold text-blue-700 text-center md:text-left whitespace-nowrap">Période : Septembre - Décembre</p>

                <!-- Boutons Export/Import/Print -->
                <div class="flex flex-wrap justify-center gap-3 w-full md:w-auto">
                    
                    <!-- Bouton PDF / Imprimer -->
                    <button onclick="window.print()" class="flex items-center space-x-2 bg-gray-700 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transition duration-150 transform hover:scale-[1.02] text-sm">
                        <!-- Icône Imprimer -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        <span>Imprimer</span>
                    </button>
                    
                    <!-- Bouton Exporter (Appelle la modale) -->
                    <button onclick="openFilenameModal()" class="flex items-center space-x-2 bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-800 transition duration-150 transform hover:scale-[1.02] text-sm">
                        <!-- Icône Exporter -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        <span>Exporter</span>
                    </button>
                    
                    <!-- Bouton Importer -->
                    <div class="relative">
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                        <label for="import-file" class="flex items-center space-x-2 bg-gray-400 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 cursor-pointer transition duration-150 transform hover:scale-[1.02] text-sm">
                            <!-- Icône Importer -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span>Importer</span>
                        </label>
                    </div>
                </div>
            </div>
            
<div class="flex justify-center items-center space-x-6 py-4 bg-white shadow-md">
    <img src="cd2000.jpeg" alt="Logo CD 2000" class="h-24 object-contain">
    <img src="idsf.png" alt="Logo IDSF" class="h-24 object-contain">
</div>
            <!-- Légende des codes couleur pour la notation (Acquis / En cours d'acquisition / Non acquis) -->
            <div class="legend-container my-6">
                <p class="text-center font-semibold mb-2">Rappel des codes couleur et de leur signification&nbsp;:</p>
                <table class="w-full text-center border border-gray-300 rounded-lg overflow-hidden text-sm">
                    <tr>
                        <td class="font-bold border border-gray-300 p-2 bg-gray-50" rowspan="2">Niveaux de<br>Maîtrise</td>
                        <td class="border border-gray-300 p-3 bg-green-500 text-white font-bold">Acquis<br><span class="text-xs font-normal">Toujours acquis</span></td>
                        <td class="border border-gray-300 p-3 bg-yellow-400 text-gray-800 font-bold">En cours d’acquisition<br><span class="text-xs font-normal">Parfois acquis</span></td>
                        <td class="border border-gray-300 p-3 bg-red-500 text-white font-bold">Non acquis<br><span class="text-xs font-normal">Jamais acquis</span></td>
                    </tr>
                    <tr>
                        <td class="border border-gray-300 p-2 font-bold">20</td>
                        <td class="border border-gray-300 p-2 font-bold">10</td>
                        <td class="border border-gray-300 p-2 font-bold">4</td>
                    </tr>
                </table>
            </div>
            <div id="bilan-content">
                <!-- Le contenu du bilan (tables) sera généré ici par JavaScript -->
                <p class="text-center text-gray-500 py-10">Chargement des critères d'évaluation...</p>
            </div>

            <!-- Section Stagiaire/Tuteur -->
            <div class="mt-10 pt-6 border-t border-gray-300">
                <p class="text-sm mb-6 italic alert-box">
                    Veuillez sélectionner le niveau d'acquisition des compétences via les cases colorées (vert&nbsp;=&nbsp;<strong>Acquis</strong>, orange&nbsp;=&nbsp;<strong>En cours d'acquisition</strong>, rouge&nbsp;=&nbsp;<strong>Non acquis</strong>) et accompagner la notation d'un avis motivé.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-base">
                    <!-- Informations Stagiaire -->
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p class="font-bold mb-2 text-gray-700 border-b border-gray-200 pb-1">STAGIAIRE</p>
                        <p class="text-gray-600">Nom: <span id="stagiaire-name" contenteditable="true" data-placeholder="Nom Prénom Stagiaire" class="text-blue-700 font-semibold"></span></p>
                    </div>
                    <!-- Informations Tuteur -->
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p class="font-bold mb-2 text-gray-700 border-b border-gray-200 pb-1">TUTEUR</p>
                        <p class="text-gray-600">Nom: <span id="tuteur-name" contenteditable="true" data-placeholder="Nom Prénom Tuteur" class="text-gray-700 font-medium"></span></p>
                    </div>
                    <!-- Informations Structure -->
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p class="font-bold mb-2 text-gray-700 border-b border-gray-200 pb-1">STRUCTURE</p>
                        <p class="text-gray-600">Nom: <span id="structure-name" contenteditable="true" data-placeholder="Nom de la structure" class="text-gray-700 font-medium"></span></p>
                    </div>
                </div>
            </div>
            
            <!-- Section Signatures -->
            <div class="mt-12 pt-8 border-t border-gray-300 grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">Signature du stagiaire :</p>
                    <canvas id="signature-stagiaire" class="border border-gray-400 w-full h-32 rounded-lg bg-white shadow-inner"></canvas>
                    <button onclick="clearSignature('stagiaire')" class="mt-2 text-sm text-red-500 hover:text-red-700 no-print font-medium">Effacer la signature</button>
                </div>
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">Signature du tuteur ou référent :</p>
                    <canvas id="signature-tuteur" class="border border-gray-400 w-full h-32 rounded-lg bg-white shadow-inner"></canvas>
                    <button onclick="clearSignature('tuteur')" class="mt-2 text-sm text-red-500 hover:text-red-700 no-print font-medium">Effacer la signature</button>
                </div>
            </div>
            
        </div> <!-- Fin de la carte professionnelle -->

    </div>

    <!-- Script LocalStorage et Logique de l'application -->
    <script>
        // Déclaration des variables globales
        let signaturePads = {};
        
        const BILAN_KEYS = {
            '1': 'bilan_1', // Décembre
            '2': 'bilan_2', // Mars
            '3': 'bilan_3', // Juin
        };

        const EVALUATION_OPTIONS = {
            'A': 'Acquis',
            'E': 'En cours d\'acquisition',
            'N': 'Non acquis'
        };

        // Critères généraux de comportement (communs aux 3 bilans)
        const COMPORTEMENT_GENERAL = [
            "Ponctualité", 
            "Assiduité", 
            "Intégration dans l'équipe", 
            "Application au travail", 
            "Initiative - adaptabilité"
        ];

        // Critères d'ENCADREMENT ET ANIMATION DES ACTIVITES PHYSIQUES ET SPORTIVES
        // (4 critères initiaux, communs aux bilans 1 et 2)
        const ENCADREMENT_BASIQUE = [
            "Gestion du groupe (Prise en main/présentation, explications/consignes, corrections, retour sur séance)",
            "Gestion de l'animation (Cohérence des animations par rapport au thème, originalité pédagogique/contenu, progression pédagogique, remédiations)",
            "Gestion de l'environnement (Espace, temps, matériel)",
            "Gestion personnelle (Attitude: vocabulaire, tenue..., motive et encourage, engagement/positionnement vis-à-vis du groupe, démonstration)"
        ];

        // Critères avancés (spécifiques au bilan 2)
        const ENCADREMENT_AVANCE = [
            "Conception de séance (Structuration de séance, définition des objectifs, description des exercices, explications pour la mise en place des exercices, définition des critères de réussite)",
            "Analyse de séance (Exposé et justification de son projet de séance, justification des choix des situations proposées par rapport au thème, en relation avec les pratiquants et l'activité, identification des principales caractéristiques du public encadré, apport de solutions aux problèmes rencontrés)"
        ];

        // Structure complète des bilans
        const EVALUATION_CRITERIA = {
            '1': {
                period: "Septembre - Décembre",
                description: "Évaluation initiale du comportement et des premières compétences d'encadrement en activités physiques.",
                sections: [
                    { title: "COMPORTEMENT GENERAL", criteria: COMPORTEMENT_GENERAL },
                    { 
                        title: "ENCADREMENT ET ANIMATION DES ACTIVITES PHYSIQUES ET SPORTIVES", 
                        criteria: ENCADREMENT_BASIQUE
                    }
                ]
            },
            '2': {
                period: "Janvier - Mars",
                description: "Évaluation intermédiaire, intégrant l'analyse et la conception de séance en plus des critères initiaux.",
                sections: [
                    { title: "COMPORTEMENT GENERAL", criteria: COMPORTEMENT_GENERAL },
                    { 
                        title: "ENCADREMENT ET ANIMATION DES ACTIVITES PHYSIQUES ET SPORTIVES", 
                        // Bilan 2 = Bilan 1 + Critères avancés
                        criteria: [...ENCADREMENT_BASIQUE, ...ENCADREMENT_AVANCE]
                    }
                ]
            },
            '3': {
                period: "Avril - Juin",
                description: "Évaluation finale axée sur l'acquisition des compétences spécifiques du diplôme BPJEPS APT.",
                sections: [
                    { title: "COMPORTEMENT GENERAL", criteria: COMPORTEMENT_GENERAL },
                    { 
                        title: "COMPETENCES EN TANT QU'EDUCATEUR BPJEPS ACTIVITES PHYSIQUES POUR TOUS", 
                        subsections: [
                            { 
                                // Correction des correspondances d'unités capitalisables (UC) pour le Bilan 3 :
                                // L'encadrement tout public relève uniquement de l'UC 1
                                subtitle: "ENCADRER TOUT PUBLIC DANS TOUT LIEU ET TOUTE STRUCTURE (UC 1)",
                                criteria: [
                                    "Communiquer dans les situations de la vie professionnelle",
                                    "Prendre en compte les caractéristiques des publics dans leurs environnements dans une démarche d'éducation à la citoyenneté",
                                    "Contribuer au fonctionnement d'une structure"
                                ]
                            },
                            { 
                                // La mise en œuvre d'un projet d'animation correspond à l'UC 2
                                subtitle: "METTRE EN ŒUVRE UN PROJET D'ANIMATION S'INSCRIVANT DANS LE PROJET DE LA STRUCTURE (UC 2)",
                                criteria: [
                                    "Concevoir un projet d'animation",
                                    "Conduire un projet d'animation",
                                    "Evaluer un projet d'animation"
                                ]
                            },
                            { 
                                // La conduite d'une séance ou d'un cycle d'animation correspond à l'UC 3
                                subtitle: "CONDUIRE UNE SEANCE, UN CYCLE D'ANIMATION OU D'APPRENTISSAGE (UC 3)",
                                criteria: [
                                    "Concevoir la séance, le cycle d'animation ou d'apprentissage",
                                    "Conduire la séance, le cycle d'animation ou d'apprentissage",
                                    "Evaluer la séance, le cycle d'animation ou d'apprentissage"
                                ]
                            },
                            { 
                                // La mobilisation des techniques de la mention APT correspond désormais à l'UC 4
                                subtitle: "MOBILISER LES TECHNIQUES DE LA MENTION ACTIVITES PHYSIQUES POUR TOUS (UC 4)",
                                criteria: [
                                    "Conduire une séance ou un cycle en utilisant les techniques de la mention",
                                    "Maîtriser et faire appliquer les règlements de la mention",
                                    "Garantir des conditions de pratique en sécurité"
                                ]
                            }
                        ] 
                    }
                ]
            }
        };

        // --- UTILS ---
        
        // Fonction pour ajuster automatiquement la hauteur du champ de motivation
        function autoGrow(element) {
            // Remet la hauteur à 'auto' pour que scrollHeight reflète la hauteur réelle du contenu
            element.style.height = 'auto'; 
            // Définit la hauteur du div à sa hauteur de défilement pour afficher tout le contenu
            element.style.height = element.scrollHeight + 'px'; 
        }
        window.autoGrow = autoGrow; // Exposer pour l'utiliser dans le HTML

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            const html = `
                <div class="${color} text-white p-3 rounded-lg shadow-xl mb-2 transform transition duration-500 ease-out translate-x-0" role="alert">
                    ${message}
                </div>
            `;
            box.insertAdjacentHTML('beforeend', html);
            setTimeout(() => {
                const item = box.lastElementChild;
                if (item) item.remove();
            }, 3000);
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- MODAL LOGIC ---
        
        function openFilenameModal() {
            // 1. Sauvegarder les données avant d'ouvrir la modale
            saveData();
            
            const modal = document.getElementById('filename-modal');
            const modalContent = document.getElementById('modal-content');
            const input = document.getElementById('filename-input');
            
            // 2. Générer le nom de fichier par défaut
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, ''); 
            // Sécuriser et formater le nom du stagiaire
            const stagiaireName = document.getElementById('stagiaire-name').textContent.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '') || 'stagiaire';
            const defaultFilename = `bilans_alternance_${stagiaireName}_${today}`;
            
            input.value = defaultFilename;
            
            // 3. Afficher la modale avec animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
                input.focus();
            }, 10);
            
            // Gérer la touche Entrée pour valider
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performExport();
                }
            };
        }
        window.openFilenameModal = openFilenameModal;

        function closeFilenameModal() {
            const modal = document.getElementById('filename-modal');
            const modalContent = document.getElementById('modal-content');

            // Cacher la modale avec animation
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            document.getElementById('filename-input').onkeydown = null; // Supprimer l'écouteur Entrée
        }
        window.closeFilenameModal = closeFilenameModal;

        function performExport() {
            const rawFilename = document.getElementById('filename-input').value.trim();
            closeFilenameModal(); // Fermer la modale
            
            // Nettoyage et sécurisation du nom de fichier
            let safeFilename = rawFilename.replace(/[^a-zA-Z0-9_\-\.]/g, '_').toLowerCase() || 'export_bilans';
            
            // Appel de la fonction d'exportation avec le nom souhaité
            exportData(safeFilename + '.json'); 
        }
        window.performExport = performExport;
        
        // --- LOCAL STORAGE / DATA PERSISTENCE ---

        function getLocalStorageKey(bilanId) {
            const docId = BILAN_KEYS[bilanId];
            // Clé unique et claire pour le localStorage
            return `bilan_evaluation_${docId}`; 
        }

        function collectData() {
            const data = {};
            // Collecter les informations générales (textContent est vide si le champ est vide)
            data.stagiaireName = document.getElementById('stagiaire-name').textContent;
            data.structureName = document.getElementById('structure-name').textContent;
            data.tuteurName = document.getElementById('tuteur-name').textContent;
            
            // Collecter les données d'évaluation
            data.evaluations = {};
            document.querySelectorAll('[data-criterion-key]').forEach(el => {
                const key = el.getAttribute('data-criterion-key');
                if (key) {
                    if (!data.evaluations[key]) data.evaluations[key] = {};
                    
                    const type = el.getAttribute('data-type');
                    
                    if (type === 'notation') {
                        // Pour le nouveau système de notation, la valeur est stockée soit dans la propriété .value, soit dans l'attribut data-selected
                        let notationValue = '';
                        if (typeof el.value !== 'undefined' && el.value !== null) {
                            notationValue = el.value;
                        } else if (el.getAttribute('data-selected')) {
                            notationValue = el.getAttribute('data-selected');
                        }
                        data.evaluations[key].notation = notationValue;
                    } else if (type === 'motivation') {
                        data.evaluations[key].motivation = el.textContent.trim();
                    }
                }
            });

            // Collecter les signatures (base64)
            const canvasStagiaire = document.getElementById('signature-stagiaire');
            const canvasTuteur = document.getElementById('signature-tuteur');

            // S'assurer que le canvas n'est pas vide avant de récupérer l'URL
            data.signatureStagiaire = signaturePads.stagiaire && !signaturePads.stagiaire.isEmpty() ? canvasStagiaire.toDataURL() : '';
            data.signatureTuteur = signaturePads.tuteur && !signaturePads.tuteur.isEmpty() ? canvasTuteur.toDataURL() : '';
            
            return data;
        }

        function saveData() {
            const bilanId = document.getElementById('bilan-select').value;
            const key = getLocalStorageKey(bilanId);
            const data = collectData();
            
            try {
                localStorage.setItem(key, JSON.stringify(data));
                // Pas de message de succès pour ne pas interrompre l'utilisateur
            } catch (e) {
                console.error("Erreur lors de la sauvegarde LocalStorage:", e);
                showMessage("Erreur: Échec de la sauvegarde locale des données.", 'error');
            }
        }
        
        const debouncedSaveData = debounce(saveData, 1000);

        function loadData(bilanId) {
            const key = getLocalStorageKey(bilanId);
            
            try {
                const storedData = localStorage.getItem(key);
                const data = storedData ? JSON.parse(storedData) : null;

                // Appliquer les données
                applyDataToPage(data || {});
            } catch (e) {
                console.error("Erreur lors du chargement LocalStorage:", e);
                showMessage("Erreur: Échec du chargement des données locales.", 'error');
                applyDataToPage({}); // Appliquer des données vides en cas d'erreur
            }
        }

        function applyDataToPage(data) {
            // Appliquer les informations générales. 
            document.getElementById('stagiaire-name').textContent = data.stagiaireName || '';
            document.getElementById('structure-name').textContent = data.structureName || '';
            document.getElementById('tuteur-name').textContent = data.tuteurName || '';

            // Réinitialiser les notations et motivations avant d'appliquer les nouvelles
            document.querySelectorAll('[data-criterion-key]').forEach(el => {
                const type = el.getAttribute('data-type');
                // Réinitialiser les notations (ancien sélecteur ou nouveau système)
                if (type === 'notation') {
                    if (el.tagName === 'SELECT') {
                        // Ancien cas : menu déroulant
                        el.value = '';
                    } else if (el.classList.contains('notation-control')) {
                        // Nouveau cas : système de cases à cocher
                        setNotationControlValue(el, '');
                    }
                } else if (type === 'motivation') {
                    // Réinitialiser le champ de motivation
                    el.textContent = '';
                    // IMPORTANT: Réinitialiser la hauteur
                    el.style.height = 'auto';
                }
            });

            // Appliquer les évaluations
            if (data.evaluations) {
                Object.entries(data.evaluations).forEach(([key, values]) => {
                    if (values.notation) {
                        // Vérifier d'abord le nouveau système de notation
                        let notationControl = document.querySelector(`.notation-control[data-criterion-key="${key}"][data-type="notation"]`);
                        if (notationControl) {
                            setNotationControlValue(notationControl, values.notation);
                        } else {
                            // Ancien cas (fallback) : menu déroulant
                            const notationEl = document.querySelector(`select[data-criterion-key="${key}"][data-type="notation"]`);
                            if (notationEl) notationEl.value = values.notation;
                        }
                    }
                    if (values.motivation) {
                        const motivationEl = document.querySelector(`[data-criterion-key="${key}"][data-type="motivation"]`);
                        if (motivationEl) {
                            motivationEl.textContent = values.motivation;
                            // Ajuster la hauteur après avoir mis le texte
                            autoGrow(motivationEl);
                        }
                    }
                });
            }

            // Le setup des pads DOIT être fait avant d'appliquer les signatures
            setupSignaturePads(); 
            
            // Appliquer les signatures
            applySignature(document.getElementById('signature-stagiaire'), data.signatureStagiaire);
            applySignature(document.getElementById('signature-tuteur'), data.signatureTuteur);
        }

        // --- DYNAMIC CONTENT GENERATION ---

        function generateEvaluationTable() {
            const bilanSelect = document.getElementById('bilan-select');
            const bilanId = bilanSelect.value;
            const bilan = EVALUATION_CRITERIA[bilanId];
            const contentDiv = document.getElementById('bilan-content');
            
            if (!bilan) {
                contentDiv.innerHTML = '<p class="text-red-500">Erreur: Critères de bilan non trouvés.</p>';
                return;
            }

            // Mise à jour de la période affichée
            document.getElementById('bilan-period').textContent = `Période : ${bilan.period}`;

            let html = `<h3 class="bilan-header">BILAN ${bilanId} : ${bilan.description}</h3>`;

            bilan.sections.forEach((section, sectionIndex) => {
                html += `
                    <h4 class="text-xl font-bold text-gray-800 mt-6 mb-3">${sectionIndex + 1}. ${section.title}</h4>
                    <table class="evaluation-table mb-8 rounded-lg overflow-hidden shadow-lg border border-gray-200">
                        <thead>
                            <tr>
                                <th class="w-2/5">CRITÈRES</th>
                                <!-- La colonne Notation n'a plus de largeur fixe afin d'accueillir des libellés complets -->
                                <th class="text-center whitespace-nowrap">NOTATION</th>
                                <th class="w-7/12">MOTIVATION DE L'ÉVALUATION</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Gérer les sous-sections spécifiques au Bilan 3
                if (section.subsections) {
                    section.subsections.forEach((subsection, subIndex) => {
                        html += `
                            <tr>
                                <td colspan="3" class="subsection-title">${subsection.subtitle}</td>
                            </tr>
                        `;
                        subsection.criteria.forEach((criterion, criterionIndex) => {
                            // Clé unique pour le critère: BilanID-SectionIndex-SubsectionIndex-CriterionIndex
                            const key = `B${bilanId}-S${sectionIndex + 1}-SS${subIndex + 1}-C${criterionIndex + 1}`;
                            html += createCriterionRow(key, criterion);
                        });
                    });
                } else {
                    // Gérer les critères standards (Bilan 1 & 2)
                    section.criteria.forEach((criterion, criterionIndex) => {
                        // Clé unique pour le critère: BilanID-SectionIndex-CriterionIndex
                        const key = `B${bilanId}-S${sectionIndex + 1}-C${criterionIndex + 1}`;
                        html += createCriterionRow(key, criterion);
                    });
                }

                html += `</tbody></table>`;
            });
            
            contentDiv.innerHTML = html;
            
            // Attacher les événements de saisie sur les champs de motivation
            document.querySelectorAll('[data-type="motivation"]').forEach(div => {
                div.removeEventListener('input', debouncedSaveData);
                div.addEventListener('input', (e) => {
                    autoGrow(e.target);
                    debouncedSaveData();
                });
            });

            // Initialiser les gestionnaires pour le nouveau système de notation
            attachNotationHandlers();

            // Recharger les données pour que les valeurs apparaissent dans les nouvelles tables
            loadData(bilanId);
        }

        function createCriterionRow(key, criterionText) {
            // Nouveau système: 3 cases de notation (Acquis, En cours d'acquisition, Non acquis)
            return `
                <tr>
                    <td class="font-medium text-gray-700 w-2/5">${criterionText}</td>
                    <td class="text-center">
                        <div class="notation-control" data-criterion-key="${key}" data-type="notation" data-selected="">
                            <!-- Les cases comportent désormais un texte pour mieux identifier les niveaux -->
                            <div class="notation-box" data-value="A" title="${EVALUATION_OPTIONS['A']}">Acquis</div>
                            <div class="notation-box" data-value="E" title="${EVALUATION_OPTIONS['E']}">En&nbsp;cours</div>
                            <div class="notation-box" data-value="N" title="${EVALUATION_OPTIONS['N']}">Non acquis</div>
                        </div>
                    </td>
                    <td class="w-7/12">
                        <!-- Champ de motivation éditable et auto-adaptable -->
                        <div data-criterion-key="${key}" data-type="motivation" contenteditable="true"
                             data-placeholder="Saisissez votre avis motivé ici..."
                             class="w-full text-gray-700 auto-grow-motivation"></div>
                    </td>
                </tr>
            `;
        }

        /**
         * Initialise les écouteurs sur les nouvelles cases de notation.
         * Chaque case correspond à une valeur (A, E ou N) et le clic met à jour
         * l'état sélectionné, applique la classe de couleur appropriée et
         * définit la propriété .value du conteneur. Une sauvegarde différée
         * est déclenchée via debouncedSaveData().
         */
        function attachNotationHandlers() {
            // Sélectionner tous les conteneurs de notation dans le tableau
            document.querySelectorAll('.notation-control').forEach(control => {
                const boxes = Array.from(control.querySelectorAll('.notation-box'));
                // Initialiser la valeur si elle n'existe pas
                if (typeof control.value === 'undefined') {
                    control.value = '';
                }
                boxes.forEach(box => {
                    box.addEventListener('click', () => {
                        const val = box.getAttribute('data-value');
                        // Nettoyer les classes sélectionnées
                        boxes.forEach(b => {
                            b.classList.remove('selected-A', 'selected-E', 'selected-N');
                        });
                        // Appliquer la nouvelle classe selon la valeur
                        if (val === 'A') box.classList.add('selected-A');
                        else if (val === 'E') box.classList.add('selected-E');
                        else if (val === 'N') box.classList.add('selected-N');
                        // Mettre à jour la valeur et l'attribut data-selected
                        control.value = val;
                        control.setAttribute('data-selected', val);
                        // Lancer la sauvegarde différée
                        debouncedSaveData();
                    });
                });
            });
        }

        /**
         * Applique visuellement une valeur préexistante à un conteneur de notation.
         * Utilisé lors du chargement des données pour restaurer l'état sélectionné.
         * @param {Element} control - le conteneur .notation-control
         * @param {String} value - la valeur à appliquer ("A", "E", "N" ou vide)
         */
        function setNotationControlValue(control, value) {
            if (!control) return;
            const boxes = Array.from(control.querySelectorAll('.notation-box'));
            // Réinitialiser les classes
            boxes.forEach(b => {
                b.classList.remove('selected-A', 'selected-E', 'selected-N');
            });
            if (value) {
                const target = control.querySelector(`.notation-box[data-value="${value}"]`);
                if (target) {
                    if (value === 'A') target.classList.add('selected-A');
                    else if (value === 'E') target.classList.add('selected-E');
                    else if (value === 'N') target.classList.add('selected-N');
                }
            }
            control.value = value || '';
            control.setAttribute('data-selected', value || '');
        }

        // --- SIGNATURE PAD LOGIC ---

        function setupSignaturePads() {
            // Initialiser les pads uniquement s'ils n'existent pas ou sont à reconfigurer
            const canvasStagiaire = document.getElementById('signature-stagiaire');
            const canvasTuteur = document.getElementById('signature-tuteur');
            
            // Redimensionner le canvas pour qu'il corresponde à son élément
            function resizeCanvas(canvas) {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                // Si pad existe, il faut reconfigurer le contexte de dessin
                if (signaturePads.stagiaire && canvas === canvasStagiaire) signaturePads.stagiaire.clear();
                if (signaturePads.tuteur && canvas === canvasTuteur) signaturePads.tuteur.clear();
                canvas.getContext('2d').scale(ratio, ratio);
            }

            if (typeof SignaturePad === 'undefined') {
                // Utiliser un chargement synchrone minimal pour éviter l'erreur si le script n'est pas encore évalué.
                return;
            }
            
            // Si les pads ne sont pas encore initialisés
            if (!signaturePads.stagiaire) {
                [canvasStagiaire, canvasTuteur].forEach(canvas => {
                    resizeCanvas(canvas);
                });

                signaturePads.stagiaire = new SignaturePad(canvasStagiaire, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    onEnd: debouncedSaveData
                });
                signaturePads.tuteur = new SignaturePad(canvasTuteur, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    onEnd: debouncedSaveData
                });
            }
            
            // Gérer le redimensionnement (mis à jour pour plus de robustesse)
            if (!window._signatureResizeListener) {
                window._signatureResizeListener = () => {
                    const currentStagiaireSig = signaturePads.stagiaire && !signaturePads.stagiaire.isEmpty() ? signaturePads.stagiaire.toDataURL() : null;
                    const currentTuteurSig = signaturePads.tuteur && !signaturePads.tuteur.isEmpty() ? signaturePads.tuteur.toDataURL() : null;

                    // Redimensionner et clear les pads (car le redimensionnement du canvas le vide)
                    [canvasStagiaire, canvasTuteur].forEach(canvas => {
                        resizeCanvas(canvas); 
                    });
                    
                    // Restaurer les signatures
                    if(currentStagiaireSig && signaturePads.stagiaire) {
                        signaturePads.stagiaire.fromDataURL(currentStagiaireSig, { ratio: Math.max(window.devicePixelRatio || 1, 1) });
                    }
                    if(currentTuteurSig && signaturePads.tuteur) {
                         signaturePads.tuteur.fromDataURL(currentTuteurSig, { ratio: Math.max(window.devicePixelRatio || 1, 1) });
                    }
                };
                window.addEventListener('resize', window._signatureResizeListener);
            }
        }

        function clearSignature(type) {
            if (signaturePads[type]) {
                signaturePads[type].clear();
                debouncedSaveData();
            }
        }
        window.clearSignature = clearSignature; // Exposer la fonction

        function applySignature(canvas, base64Image) {
            const type = canvas.id.replace('signature-', '');
            const pad = signaturePads[type];
            
            if (!pad) return;

            if (!base64Image || base64Image.length < 50) {
                pad.clear();
                return;
            }

            if (typeof pad.fromDataURL === 'function') {
                // Restaurer l'image en tenant compte du ratio de pixel pour la qualité
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                pad.fromDataURL(base64Image, { ratio: ratio }); 
            }
        }
        
        // --- EXPORT / IMPORT LOGIC (LocalStorage Version) ---

        // Mise à jour de la fonction exportData pour accepter le nom de fichier
        function exportData(fileName) {
            // Sauvegarder les données actuelles en LocalStorage avant l'export
            saveData(); 

            const allData = {};
            // Itérer sur TOUS les bilans pour tout exporter
            for (const [bilanId, docId] of Object.entries(BILAN_KEYS)) {
                const key = getLocalStorageKey(bilanId);
                const storedData = localStorage.getItem(key);

                if (storedData) {
                    // Utiliser le docId comme clé de haut niveau pour l'importation
                    allData[docId] = JSON.parse(storedData);
                }
            }

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Utiliser le nom de fichier fourni par l'utilisateur
            const finalFileName = fileName || 'bilans_alternance.json';
            
            a.download = finalFileName; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage(`Tous les 3 bilans ont été exportés dans le fichier : ${finalFileName}`, 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let importedCount = 0;
                    
                    // Itérer sur les données importées pour les sauvegarder une par une dans LocalStorage
                    for (const [docId, data] of Object.entries(importedData)) {
                        // Chercher l'ID de bilan correspondant (ex: 'bilan_1' -> '1')
                        const bilanId = Object.keys(BILAN_KEYS).find(key => BILAN_KEYS[key] === docId);
                        
                        if (bilanId) {
                            const key = getLocalStorageKey(bilanId);
                            localStorage.setItem(key, JSON.stringify(data));
                            importedCount++;
                        } else {
                            console.warn(`Données ignorées pour l'ID de document inconnu: ${docId}`);
                        }
                    }
                    
                    // Recharger le bilan actuellement affiché pour voir les changements
                    // La régénération de la table appelle loadData à la fin
                    generateEvaluationTable(); 
                    
                    showMessage(`Importation réussie ! ${importedCount} bilan(s) mis à jour.`, 'success');
                } catch (error) { 
                    console.error("Erreur lors de l'importation:", error);
                    showMessage('Erreur: Fichier JSON invalide ou corrompu. Assurez-vous d\'importer le fichier JSON précédemment exporté.'); 
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Réinitialiser l'input file
        }
        window.importData = importData; // Exposer la fonction

        // --- INITIALISATION ---
        
        function initApp() {
            // Listener pour le changement de bilan
            const bilanSelect = document.getElementById('bilan-select');
            bilanSelect.addEventListener('change', (e) => {
                // La régénération de la table appelle loadData à la fin
                generateEvaluationTable();
            });
            
            // Listener global pour la sauvegarde auto sur les champs éditables (infos générales)
            document.getElementById('app').addEventListener('input', (e) => {
                const isEditableField = e.target.closest('[contenteditable="true"]');
                
                // Ne sauvegarder que si c'est un champ éditable qui n'est pas dans le tableau d'évaluation
                if (isEditableField && !e.target.closest('.evaluation-table')) { 
                    debouncedSaveData();
                }
            });
            
            // Initialiser le premier bilan (Bilan 1 par défaut)
            generateEvaluationTable(); 
        }

        // Exiger l'ajout de la librairie Signature Pad pour les signatures
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js';
        script.onload = () => {
            initApp();
        };
        document.head.appendChild(script);

    </script>
</body>
<footer class="bg-blue-900 py-4 mt-10 text-center">
    <img src="bandeau.jpg" alt="Logo Région" class="h-24 mx-auto">
</footer>
</html>
