<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilan d'Évaluation Tuteur - Alternance</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et des utilitaires responsives -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter et styles de conteneur */
        html { font-family: 'Inter', sans-serif; }
        
        .page-container {
            max-width: 1000px; 
            margin: 0 auto;
            padding: 1rem; 
        }
        @media (min-width: 640px) { /* sm */
             .page-container {
                padding: 2rem;
                border: 1px solid #e0e0e0;
                border-radius: 0.75rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                margin: 2rem auto;
            }
        }
        
        /* Styles pour les champs éditables */
        [contenteditable="true"] {
            border-bottom: 2px dashed #e0e0e0;
            padding: 2px 4px;
            min-width: 50px;
            display: inline-block;
            transition: border-bottom-color 0.2s;
            outline: none;
            cursor: text;
        }
        [contenteditable="true"]:focus {
            border-bottom-color: #3b82f6;
            background-color: #f0f8ff;
        }

        /* Assure que le texte passe à la ligne (word-wrap) */
        .motivation-field {
            white-space: pre-wrap; 
            height: auto; 
        }
        
        /* Style pour les champs vides avec texte d'indication */
        .empty-field::before {
            content: attr(data-placeholder);
            color: #9ca3af; 
            pointer-events: none; 
        }
        /* Cache le texte d'indication quand le champ a le focus ou n'est pas vide */
        .empty-field:focus::before, [contenteditable="true"]:not(.empty-field)::before {
            content: none;
        }

        /* Styles spécifiques au tableau d'évaluation */
        .eval-table {
            border-collapse: collapse;
            width: 100%;
        }
        .eval-table th, .eval-table td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            font-size: 0.875rem; 
            vertical-align: middle; 
        }
        .eval-table th {
            background-color: #e0f2f7; 
            color: #0c4a6e; 
            text-align: center;
            font-weight: 700;
        }
        .eval-table th:first-child {
            text-align: left; 
        }
        
        /* Colonnes Acquis (J) / Entre les deux (K) / Non Acquis (L) */
        .col-eval {
            width: 100px; 
            text-align: center;
            font-weight: bold;
            transition: background-color 0.1s;
        }
        
        /* Couleurs pour les scores J, K, L */
        .col-j { background-color: #d1fae5; }
        .col-k { background-color: #fffbeb; }
        .col-l { background-color: #fee2e2; }

        /* Case à cocher personnalisée */
        .checkbox-cell {
            cursor: pointer;
            user-select: none;
            padding: 4px; 
        }
        .checkbox-cell:hover {
            opacity: 0.8;
        }
        .checked-x {
            font-size: 1.25rem;
            font-weight: 900;
        }
        
        /* Couleur de la croix en fonction de la colonne */
        .col-j .checked-x { color: #065f46; }
        .col-k .checked-x { color: #b45309; }
        .col-l .checked-x { color: #dc2626; }
        
        /* Styles pour la zone de signature */
        .signature-box {
            border: 2px solid #3b82f6; 
            border-radius: 0.5rem;
            height: 120px; 
            background-color: #f9fafb;
            cursor: crosshair; 
        }
        .signature-box canvas {
            display: block;
        }
        
        /* Conteneur des tables pour faciliter l'impression */
        .table-container {
            margin-bottom: 2rem;
        }

        /* Style des Modals */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 650px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        /* ======================================================= */
        /* MEDIA QUERY POUR L'IMPRESSION (VERSION A4 PROPRE) */
        /* ======================================================= */
        @page {
            size: A4 portrait;
            margin: 0.5cm;
        }
        
        @media print {
            .no-print { display: none !important; }
            body { margin: 0; padding: 0; background-color: white !important; }
            .page-container { 
                width: 100%; 
                margin: 0; 
                padding: 0.5cm;
                border: none; 
                box-shadow: none; 
                max-width: none;
                font-size: 10pt;
            }
            h1, h2 { color: #000 !important; }
            
            /* FORCER LA DENSITÉ POUR GAGNER DE L'ESPACE VERTICAL */
            .table-container {
                margin-bottom: 0.8rem !important; 
            }
            .eval-table th, .eval-table td {
                border-color: #444 !important;
                padding: 2px 4px !important; 
                font-size: 7.5pt; 
                line-height: 1.2;
                vertical-align: top; 
            }
            .eval-table th { 
                background-color: #eee !important; 
                color: #000 !important;
                font-size: 7pt !important; 
                line-height: 1.1;
                text-align: center;
            }
             .eval-table th:first-child {
                text-align: left;
                font-size: 7.5pt !important;
            }

            .col-j { background-color: #d4edda !important; } 
            .col-k { background-color: #fff3cd !important; } 
            .col-l { background-color: #f8d7da !important; } 
            
            /* ÉVITER LES SAUTS DE PAGE INOPPORTUNS */
            .table-container {
                page-break-after: avoid; 
                page-break-inside: auto; 
            }
            
            /* Optimisation des signatures */
            .signature-zone {
                margin-top: 0.5rem !important; 
                padding-top: 0.5rem !important; 
                border-top-width: 1px !important; 
            }
            
            .signature-wrapper {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                gap: 0.8rem !important; 
                margin-top: 0.5rem !important;
            }
            .signature-area { 
                width: 49% !important; 
                padding: 0;
            }
            .signature-box {
                border: 1px solid #000 !important; 
                height: 70px !important; 
                background-color: transparent !important;
            }

            /* Nettoyage des champs éditables et suppression des placeholders */
            [contenteditable="true"] { 
                border-bottom: 1px solid #000 !important; 
                background-color: transparent !important;
                color: #000 !important;
                min-width: 80px !important;
                display: block;
            }
            .empty-field::before {
                content: none !important; 
            }
            /* Assure que la motivation ne crée pas de scrollbar horizontale */
            .motivation-field {
                overflow: visible !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Barre de Navigation -->
<nav class="bg-blue-900 shadow-lg sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center justify-center h-16">
            <div class="flex space-x-4">
                <a href="index.html" class="text-gray-300 hover:bg-blue-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">📅</span> Feuille de Suivi
                </a>
                <a href="bilan.html" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">📄</span> Bilan Final
                </a>
                <a href="#" onclick="openModal('tuto-modal')" class="text-gray-300 hover:bg-blue-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">
                    <span class="text-xl mr-2">💡</span> Tutoriel
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Modal d'export PDF (Explicatif) -->
<div id="pdf-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">📄</span> Exporter en PDF
        </h3>
        <p class="mb-4 text-gray-700">
            Pour imprimer ou enregistrer ce bilan au format PDF, cliquez sur le bouton ci-dessous, puis choisissez **"Enregistrer au format PDF"** dans les options d'impression de votre navigateur.
        </p>
        <button onclick="launchPrint()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-md w-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Lancer l'impression
        </button>
    </div>
</div>

<!-- Modal Tutoriel -->
<div id="tuto-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
            <span class="mr-2 text-2xl">💡</span> Guide d'utilisation
        </h3>
        
        <div class="text-left space-y-4 text-gray-800">
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                <p class="font-bold">Attention : Sauvegarde Locale Uniquement</p>
                <p>Toutes les données que vous saisissez sont sauvegardées **uniquement sur votre ordinateur et dans le navigateur que vous utilisez actuellement**. Si vous changez d'appareil ou nettoyez les données de votre navigateur, les informations seront perdues.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Exporter toutes vos données :</h4>
                <p>Utilisez le bouton <strong class="text-blue-600">"Exporter TOUT (JSON)"</strong> pour créer un fichier de sauvegarde unique contenant les informations de la feuille de suivi (tous les mois) et du bilan. Il est conseillé de faire des sauvegardes régulièrement.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Importer des données :</h4>
                <p>Si vous changez d'ordinateur ou si vous voulez récupérer une sauvegarde, cliquez sur <strong class="text-yellow-600">"Importer (JSON)"</strong> et sélectionnez le fichier `.json` que vous aviez précédemment exporté. Toutes vos données seront restaurées.</p>
            </div>

            <div>
                <h4 class="font-bold text-lg">Envoyer votre sauvegarde par e-mail :</h4>
                <p>Après avoir exporté vos données, vous obtiendrez un fichier (ex: `sauvegarde-livret.json`). Vous pouvez simplement joindre ce fichier à un e-mail comme n'importe quelle autre pièce jointe pour le partager ou le conserver.</p>
            </div>
        </div>

        <button onclick="closeModal('tuto-modal')" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-full">
            J'ai compris
        </button>
    </div>
</div>

<div id="app" class="page-container bg-white">
    <header class="text-center mb-6">
        <h1 class="text-xl md:text-2xl font-extrabold text-blue-800 border-b-4 border-blue-200 pb-2">
            BILAN D'ÉVALUATION TUTEUR - FORMATION BPJEPS
        </h1>
    </header>
    
    <!-- Boutons d'action -->
    <div class="no-print text-center mb-6 flex flex-wrap items-center justify-center gap-4">
        <button onclick="openModal('pdf-modal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
            PDF (Bilan Seul)
        </button>
        <button onclick="exportAllData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
            ⬇️ Exporter TOUT (JSON)
        </button>
        <button onclick="document.getElementById('import-file').click()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-2.5 px-6 rounded-xl transition duration-200 shadow-lg">
            ⬆️ Importer (JSON)
        </button>
        <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
        <p id="message-box" class="w-full mt-2 text-center text-sm font-medium text-red-600"></p>
    </div>

    <!-- Informations générales (Période et Stagiaire) -->
    <div class="mb-6 p-4 border rounded-lg bg-blue-50/50 shadow-sm text-sm md:text-base">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <p>
                <strong>PÉRIODE :</strong> 
                <span id="period" contenteditable="true" data-field="period" data-placeholder="Ex: DU 15/09/2025 AU 31/12/2025" class="empty-field font-bold"></span>
            </p>
            <p>
                <strong>STAGIAIRE :</strong> 
                <span id="stagiaire-name" contenteditable="true" data-field="stagiaireName" data-placeholder="Nom et Prénom du stagiaire" class="empty-field font-bold"></span>
            </p>
        </div>
        <p class="mt-4 text-xs italic text-gray-600 border-t pt-2">
            Merci de mettre une croix (clic) dans les cases concernées et d'accompagner la notation d'un avis motivé dans la colonne "MOTIVATION DE L'ÉVALUATION". (Acquis=Vert, Entre les deux=Orange, Non Acquis=Rouge).
        </p>
    </div>

    <!-- Section 1 : COMPORTEMENT GENERAL -->
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider">COMPORTEMENT GÉNÉRAL</h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
            <thead>
                <tr>
                    <th class="w-1/2">CRITÈRES</th>
                    <th class="col-eval col-j">Acquis</th>
                    <th class="col-eval col-k">Entre les deux</th>
                    <th class="col-eval col-l">Non Acquis</th>
                    <th class="w-1/4 text-center">MOTIVATION DE L'ÉVALUATION</th>
                </tr>
            </thead>
            <tbody id="comportement-body">
                <!-- Les lignes d'évaluation sont ajoutées par JS -->
            </tbody>
        </table>
    </div>
    
    <!-- Section 2 : COMPETENCES BPJEPS -->
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider mt-6">
        UC1 : ENCADRER TOUT PUBLIC DANS TOUT LIEU ET TOUTE STRUCTURE
    </h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
             <thead>
                <tr>
                    <th class="w-1/2">CRITÈRES</th>
                    <th class="col-eval col-j">Acquis</th>
                    <th class="col-eval col-k">Entre les deux</th>
                    <th class="col-eval col-l">Non Acquis</th>
                    <th class="w-1/4 text-center">MOTIVATION DE L'ÉVALUATION</th>
                </tr>
            </thead>
            <tbody id="competences-uc1-body">
            </tbody>
        </table>
    </div>
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider mt-6">
        UC2 : METTRE EN ŒUVRE UN PROJET D’ANIMATION S’INSCRIVANT DANS LE PROJET DE LA STRUCTURE
    </h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
             <thead>
                <tr>
                    <th class="w-1/2">CRITÈRES</th>
                    <th class="col-eval col-j">Acquis</th>
                    <th class="col-eval col-k">Entre les deux</th>
                    <th class="col-eval col-l">Non Acquis</th>
                    <th class="w-1/4 text-center">MOTIVATION DE L'ÉVALUATION</th>
                </tr>
            </thead>
            <tbody id="competences-uc2-body">
            </tbody>
        </table>
    </div>
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider mt-6">
        UC3 : CONDUIRE UNE SÉANCE, UN CYCLE D’ANIMATION OU D’APPRENTISSAGE
    </h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
             <thead>
                <tr>
                    <th class="w-1/2">CRITÈRES</th>
                    <th class="col-eval col-j">Acquis</th>
                    <th class="col-eval col-k">Entre les deux</th>
                    <th class="col-eval col-l">Non Acquis</th>
                    <th class="w-1/4 text-center">MOTIVATION DE L'ÉVALUATION</th>
                </tr>
            </thead>
            <tbody id="competences-uc3-body">
            </tbody>
        </table>
    </div>
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider mt-6">
        UC4 : MOBILISER LES TECHNIQUES DE LA MENTION POUR METTRE EN ŒUVRE UNE SÉANCE
    </h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
            <thead>
                <tr>
                    <th class="w-1/2">CRITÈRES</th>
                    <th class="col-eval col-j">Acquis</th>
                    <th class="col-eval col-k">Entre les deux</th>
                    <th class="col-eval col-l">Non Acquis</th>
                    <th class="w-1/4 text-center">MOTIVATION DE L'ÉVALUATION</th>
                </tr>
            </thead>
            <tbody id="competences-uc4-body">
            </tbody>
        </table>
    </div>

    <!-- Section 3 : ACTIVITÉS ET PUBLICS -->
    <h2 class="text-lg font-bold text-gray-800 mb-3 uppercase tracking-wider mt-6">ACTIVITÉS PHARES ET PUBLICS ENCADRÉS</h2>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg border border-gray-200">
        <table class="eval-table bg-white">
            <thead>
                <tr>
                    <th class="w-1/3">ACTIVITÉS TYPES</th>
                    <th colspan="6">PUBLICS</th>
                </tr>
                <tr>
                    <th></th>
                    <th class="text-xs font-semibold">Jeunes enfants</th>
                    <th class="text-xs font-semibold">Enfants</th>
                    <th class="text-xs font-semibold">Préados et ados</th>
                    <th class="text-xs font-semibold">Adultes</th>
                    <th class="text-xs font-semibold">Seniors</th>
                    <th class="text-xs font-semibold">Situation handicap</th>
                </tr>
            </thead>
            <tbody id="activites-table-body">
                <!-- Lignes générées par JS -->
            </tbody>
        </table>
    </div>

    <!-- Zones de Signature -->
    <div class="signature-zone mt-10 pt-6 border-t-2 border-gray-400">
        <div class="signature-wrapper flex flex-col md:flex-row justify-between gap-8 text-sm md:text-base">
            <div class="signature-area w-full md:w-1/2 bg-white p-4 rounded-xl shadow-lg border">
                <p class="font-semibold mb-2 text-indigo-800">Signature du stagiaire :</p>
                <div id="signature-stagiaire-box" class="signature-box">
                    <canvas id="canvas-stagiaire" class="w-full h-full" data-signature-id="stagiaire"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-stagiaire')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>
            <div class="signature-area w-full md:w-1/2 bg-white p-4 rounded-xl shadow-lg border">
                <p class="font-semibold mb-2 text-indigo-800">Signature du tuteur ou référent :</p>
                <div id="signature-tuteur-box" class="signature-box">
                    <canvas id="canvas-tuteur" class="w-full h-full" data-signature-id="tuteur"></canvas>
                </div>
                <button onclick="clearCanvas('canvas-tuteur')" class="no-print text-xs text-red-500 hover:text-red-700 mt-2 font-medium transition duration-150">
                    Effacer la signature
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const criteria = {
        comportement: [
            "Ponctualité", "Assiduité", "Intégration dans l'équipe", "Application au travail", "Initiative - adaptabilité",
        ],
        competences: {
            'uc1': { list: ["Communiquer dans les situations de la vie professionnelle", "Prendre en compte les caractéristiques des publics dans leurs environnements dans une démarche d'éducation à la citoyenneté", "Contribuer au fonctionnement d’une structure"] },
            'uc2': { list: ["Concevoir un projet d’animation", "Conduire un projet d’animation", "Évaluer un projet d’animation"] },
            'uc3': { list: ["Concevoir la séance, le cycle d’animation ou d’apprentissage", "Conduire la séance, le cycle d’animation ou d’apprentissage", "Évaluer la séance, le cycle d’animation ou d’apprentissage"] },
            'uc4': { list: ["Conduire une séance ou un cycle en utilisant les techniques de la mention", "Maîtriser et faire appliquer les règlements de la mention", "Garantir des conditions de pratique en sécurité"] }
        }
    };
    const columnClasses = { 'J': 'col-j', 'K': 'col-k', 'L': 'col-l' };
    const publics = ["jeunes_enfants", "enfants", "preados_ados", "adultes", "seniors", "handicap"];

    const STORAGE_KEY_BILAN = 'livret_alternance_bilan_v2_data';
    const STORAGE_KEY_ACTIVITES = 'livret_alternance_activites_data';
    let canvasStagiaire, canvasTuteur;
    
    function initCanvasRefs() {
        canvasStagiaire = document.getElementById('canvas-stagiaire');
        canvasTuteur = document.getElementById('canvas-tuteur');
    }

    function debounce(func, delay) {
        let timeoutId;
        return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(this, args), delay); };
    }
    
    function showMessage(msg, type = 'error') {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = msg;
        messageBox.className = 'w-full mt-2 text-center text-sm font-medium ';
        messageBox.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
        clearTimeout(messageBox.timeoutId);
        messageBox.timeoutId = setTimeout(() => { messageBox.textContent = ''; }, 4000);
    }
    
    // --- GESTION DES DONNÉES DU BILAN ---
    function getDataForSave() {
        const data = { motivations: {}, evaluation: {} };
        document.querySelectorAll('[contenteditable="true"][data-field]').forEach(el => {
            const field = el.getAttribute('data-field');
            const content = el.textContent.trim();
            data[field] = (!el.classList.contains('empty-field') || content !== '') ? content : '';
        });
        document.querySelectorAll('.eval-row').forEach(row => {
            const uid = row.getAttribute('data-uid');
            const motivationEl = row.querySelector('[data-field-type="motivation"]');
            if (motivationEl) data.motivations[uid] = motivationEl.innerText;
            const checkedCell = row.querySelector('.checkbox-cell.checked');
            data.evaluation[uid] = checkedCell ? checkedCell.getAttribute('data-score') : null;
        });
        data.signatureStagiaire = canvasStagiaire ? canvasStagiaire.toDataURL('image/png') : null;
        data.signatureTuteur = canvasTuteur ? canvasTuteur.toDataURL('image/png') : null;
        return data;
    }

    function applyDataToPage(data) {
        if (!data) return;
        document.querySelectorAll('[contenteditable="true"][data-field]').forEach(el => {
            const field = el.getAttribute('data-field');
            if (data[field] !== undefined) {
                el.textContent = data[field] || '';
                el.classList.toggle('empty-field', !data[field]);
            }
        });
        document.querySelectorAll('.eval-row').forEach(row => {
            const uid = row.getAttribute('data-uid');
            if (data.motivations && data.motivations[uid] !== undefined) {
                row.querySelector('[data-field-type="motivation"]').innerText = data.motivations[uid];
            }
            if (data.evaluation) {
                const savedScore = data.evaluation[uid];
                row.querySelectorAll('.checkbox-cell').forEach(cell => {
                    const isChecked = cell.getAttribute('data-score') === savedScore;
                    cell.classList.toggle('checked', isChecked);
                    cell.innerHTML = isChecked ? '<span class="checked-x">X</span>' : '';
                });
            }
        });
        loadSignature('canvas-stagiaire', data.signatureStagiaire);
        loadSignature('canvas-tuteur', data.signatureTuteur);
    }
    
    const debouncedSaveData = debounce(() => {
        try {
            localStorage.setItem(STORAGE_KEY_BILAN, JSON.stringify(getDataForSave()));
            showMessage("Données du bilan sauvegardées.", 'success');
        } catch (error) { showMessage("Erreur de sauvegarde du bilan."); }
    }, 500); 

    // --- GESTION DES DONNÉES DES ACTIVITÉS ---
    function getActivitesDataForSave() {
        const data = [];
        document.querySelectorAll('#activites-table-body tr').forEach(row => {
            const rowIndex = row.getAttribute('data-row-index');
            const activityText = row.querySelector(`[data-field="activity-text"]`).textContent.trim();
            const checkedPublics = [];
            publics.forEach(p => {
                const cell = row.querySelector(`.public-cell[data-public="${p}"]`);
                if (cell && cell.classList.contains('checked')) {
                    checkedPublics.push(p);
                }
            });
            data.push({ activity: activityText, publics: checkedPublics });
        });
        return data;
    }

    function applyActivitesDataToPage(data) {
        if (!data || !Array.isArray(data)) return;
        document.querySelectorAll('#activites-table-body tr').forEach((row, index) => {
            const rowData = data[index];
            if (!rowData) return;
            row.querySelector(`[data-field="activity-text"]`).textContent = rowData.activity || '';
            publics.forEach(p => {
                const cell = row.querySelector(`.public-cell[data-public="${p}"]`);
                const isChecked = rowData.publics && rowData.publics.includes(p);
                cell.classList.toggle('checked', isChecked);
                cell.innerHTML = isChecked ? '<span class="checked-x">X</span>' : '';
                cell.closest('td').style.backgroundColor = isChecked ? '#d1fae5' : '';
            });
        });
    }

    const debouncedSaveActivites = debounce(() => {
        try {
            localStorage.setItem(STORAGE_KEY_ACTIVITES, JSON.stringify(getActivitesDataForSave()));
            showMessage("Données des activités sauvegardées.", 'success');
        } catch (error) { showMessage("Erreur de sauvegarde des activités."); }
    }, 500);

    // --- GÉNÉRATION DES TABLEAUX ---
    function generateEvaluationTable() {
        const createRow = (text, uid) => `
            <tr class="eval-row hover:bg-gray-50" data-uid="${uid}">
                <td class="criteria-text">${text}</td>
                <td class="col-eval checkbox-cell ${columnClasses.J}" data-score="J" onclick="toggleScore(this)"></td>
                <td class="col-eval checkbox-cell ${columnClasses.K}" data-score="K" onclick="toggleScore(this)"></td>
                <td class="col-eval checkbox-cell ${columnClasses.L}" data-score="L" onclick="toggleScore(this)"></td>
                <td><div contenteditable="true" data-field-type="motivation" class="w-full min-h-[30px] text-gray-700 text-xs p-1 motivation-field" data-placeholder="Avis du tuteur ici"></div></td>
            </tr>`;
        
        document.getElementById('comportement-body').innerHTML = criteria.comportement.map((crit, i) => createRow(crit, `comp-${i}`)).join('');
        Object.keys(criteria.competences).forEach(ucKey => {
            const uc = criteria.competences[ucKey];
            document.getElementById(`competences-${ucKey}-body`).innerHTML = uc.list.map((crit, i) => createRow(crit, `${ucKey}-${i}`)).join('');
        });
    }
    
    function generateActivitesTable() {
        const tableBody = document.getElementById('activites-table-body');
        let html = '';
        for (let i = 0; i < 5; i++) {
            html += `<tr data-row-index="${i}">
                <td><div contenteditable="true" data-field="activity-text" data-placeholder="Décrire l'activité..." class="w-full p-1 empty-field"></div></td>
                ${publics.map(p => `<td class="text-center"><div class="public-cell checkbox-cell" data-public="${p}" onclick="togglePublic(this)"></div></td>`).join('')}
            </tr>`;
        }
        tableBody.innerHTML = html;
        tableBody.addEventListener('input', (e) => {
             if (e.target.getAttribute('data-field') === 'activity-text') {
                e.target.classList.toggle('empty-field', e.target.textContent.trim() === '');
                debouncedSaveActivites();
             }
        });
    }

    window.toggleScore = function(cell) {
        const row = cell.closest('.eval-row');
        if (cell.classList.contains('checked')) {
            cell.classList.remove('checked');
            cell.innerHTML = '';
        } else {
            row.querySelectorAll('.checkbox-cell').forEach(c => { c.classList.remove('checked'); c.innerHTML = ''; });
            cell.classList.add('checked');
            cell.innerHTML = '<span class="checked-x">X</span>';
        }
        debouncedSaveData();
    }

    window.togglePublic = function(cell) {
        const isChecked = cell.classList.toggle('checked');
        cell.innerHTML = isChecked ? '<span class="checked-x">X</span>' : '';
        cell.closest('td').style.backgroundColor = isChecked ? '#d1fae5' : '';
        debouncedSaveActivites();
    }

    // --- SIGNATURES ---
    function loadSignature(canvasId, base64) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !base64) return;
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = base64;
    }

    window.clearCanvas = (id) => {
        const canvas = document.getElementById(id);
        if(canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        debouncedSaveData(); 
    }

    function setupSignaturePads() {
        initCanvasRefs();
        [canvasStagiaire, canvasTuteur].forEach(canvas => {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let isDrawing = false, lastX = 0, lastY = 0;

            const setCanvasSize = () => {
                const dataUrl = canvas.toDataURL();
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
                loadSignature(canvas.id, dataUrl);
            };
            setCanvasSize();

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return [clientX - rect.left, clientY - rect.top];
            };
            const start = (e) => { isDrawing = true; [lastX, lastY] = getPos(e); e.preventDefault(); };
            const draw = (e) => { if (!isDrawing) return; const [x, y] = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke(); [lastX, lastY] = [x, y]; };
            const stop = () => { if (isDrawing) { isDrawing = false; debouncedSaveData(); } };
            
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseout', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);
            window.addEventListener('resize', debounce(setCanvasSize, 250));
        });
    }

    // --- MODALS ---
    window.openModal = (id) => { document.getElementById(id).style.display = 'flex'; }
    window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; }
    window.launchPrint = () => { closeModal('pdf-modal'); setTimeout(() => window.print(), 100); }
    
    // --- EXPORT / IMPORT GLOBAL ---
    function exportAllData() {
        const filename = prompt("Veuillez nommer votre fichier de sauvegarde :", `sauvegarde-livret-${new Date().toISOString().split('T')[0]}.json`);
        if (!filename) return;

        const allData = { suivi: {}, bilan: null, activites: null };
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('livret_alternance_data_')) {
                allData.suivi[key] = JSON.parse(localStorage.getItem(key));
            }
        }
        allData.bilan = JSON.parse(localStorage.getItem(STORAGE_KEY_BILAN));
        allData.activites = JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIVITES));
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename.endsWith('.json') ? filename : `${filename}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        showMessage('Exportation complète réussie !', 'success');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.suivi && !data.bilan) throw new Error("Format invalide");

                Object.keys(data.suivi || {}).forEach(key => localStorage.setItem(key, JSON.stringify(data.suivi[key])));
                if (data.bilan) localStorage.setItem(STORAGE_KEY_BILAN, JSON.stringify(data.bilan));
                if (data.activites) localStorage.setItem(STORAGE_KEY_ACTIVITES, JSON.stringify(data.activites));
                
                showMessage('Importation réussie ! La page va se recharger.', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (error) { showMessage('Erreur: Fichier invalide ou corrompu.'); }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    }
    
    // --- INITIALISATION ---
    function initApp() {
        generateEvaluationTable();
        generateActivitesTable();
        setupSignaturePads();
        
        // Chargement des données
        try {
            const bilanData = JSON.parse(localStorage.getItem(STORAGE_KEY_BILAN));
            if (bilanData) applyDataToPage(bilanData);
            const activitesData = JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIVITES));
            if (activitesData) applyActivitesDataToPage(activitesData);
        } catch (e) { console.error("Erreur au chargement des données initiales", e); }
        
        // Listeners pour sauvegarde auto
        document.getElementById('app').addEventListener('input', (e) => {
            if (e.target.closest('[contenteditable]')) {
                if (e.target.closest('#activites-table-body')) {
                    // géré par le listener de la table activités
                } else {
                    debouncedSaveData();
                }
            }
        });
    }

    window.onload = initApp;
</script>
</body>
</html>

